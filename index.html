<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Restaurant Management System - KSA Tax Compliant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        .section-container {
            min-height: auto;
            margin-bottom: 1rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

            .btn-primary:hover {
                background: #2563eb;
            }

        .btn-success {
            background: #10b981;
            color: white;
        }

            .btn-success:hover {
                background: #059669;
            }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

            .btn-danger:hover {
                background: #dc2626;
            }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

            .btn-warning:hover {
                background: #d97706;
            }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

            .btn-info:hover {
                background: #0891b2;
            }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

            .form-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

            .table th,
            .table td {
                padding: 0.5rem;
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
            }

            .table th {
                background: #f9fafb;
                font-weight: 600;
            }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-preparing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-ready {
            background: #d1fae5;
            color: #065f46;
        }

        .status-delivered {
            background: #e5e7eb;
            color: #374151;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4, .grid-5 {
                grid-template-columns: 1fr;
            }
        }

        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

            .nav-tab.active {
                border-bottom-color: #3b82f6;
                color: #3b82f6;
                font-weight: 600;
            }

            .nav-tab:hover {
                background: #f9fafb;
            }

        .hidden {
            display: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .stats-card {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        .stats-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .low-stock {
            color: #ef4444;
            font-weight: bold;
        }

        .receipt-container {
            background: white;
            padding: 2rem;
            border: 1px solid #ddd;
            font-family: monospace;
        }

        .qr-code {
            text-align: center;
            margin: 1rem 0;
        }

        .loyalty-tier-bronze {
            background: #cd7f32;
            color: white;
        }

        .loyalty-tier-silver {
            background: #c0c0c0;
            color: white;
        }

        .loyalty-tier-gold {
            background: #ffd700;
            color: black;
        }

        .loyalty-tier-platinum {
            background: #e5e4e2;
            color: black;
        }

        .kitchen-order {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

            .kitchen-order.urgent {
                background: #f8d7da;
                border-color: #dc3545;
            }

        .ar-text {
            direction: rtl;
            text-align: right;
        }

        .bilingual {
            display: flex;
            justify-content: space-between;
        }

        .currency-sar:before {
            content: "ر.س ";
        }

        @media print {
            body {
                print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 py-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-utensils text-xl text-blue-600 mr-2"></i>
                    <h1 class="text-xl font-bold text-gray-800">Enhanced Restaurant Management System</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <select id="languageSelect" onchange="changeLanguage()" class="form-input" style="width: auto; margin: 0;">
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                    </select>
                    <select id="branchSelect" onchange="changeBranch()" class="form-input" style="width: auto; margin: 0;">
                        <option value="main">Main Branch</option>
                        <option value="branch1">Branch 1</option>
                        <option value="branch2">Branch 2</option>
                    </select>
                    <button onclick="exportDataJSON()" class="btn btn-primary btn-sm">
                        <i class="fas fa-download"></i>Export
                    </button>
                    <button onclick="importData()" class="btn btn-info btn-sm">
                        <i class="fas fa-upload"></i>Import
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 py-2 no-print">
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')"><i class="fas fa-tachometer-alt mr-1"></i>Dashboard</div>
            <div class="nav-tab" onclick="showTab('orders')"><i class="fas fa-receipt mr-1"></i>Orders</div>
            <div class="nav-tab" onclick="showTab('kitchen')"><i class="fas fa-fire mr-1"></i>Kitchen</div>
            <div class="nav-tab" onclick="showTab('menu')"><i class="fas fa-utensils mr-1"></i>Menu</div>
            <div class="nav-tab" onclick="showTab('inventory')"><i class="fas fa-boxes mr-1"></i>Inventory</div>
            <div class="nav-tab" onclick="showTab('customers')"><i class="fas fa-users mr-1"></i>Customers</div>
            <div class="nav-tab" onclick="showTab('loyalty')"><i class="fas fa-star mr-1"></i>Loyalty</div>
            <div class="nav-tab" onclick="showTab('reservations')"><i class="fas fa-calendar mr-1"></i>Reservations</div>
            <div class="nav-tab" onclick="showTab('staff')"><i class="fas fa-user-tie mr-1"></i>Staff</div>
            <div class="nav-tab" onclick="showTab('suppliers')"><i class="fas fa-truck mr-1"></i>Suppliers</div>
            <div class="nav-tab" onclick="showTab('reports')"><i class="fas fa-chart-bar mr-1"></i>Reports</div>
            <div class="nav-tab" onclick="showTab('settings')"><i class="fas fa-cog mr-1"></i>Settings</div>
        </div>

        <div id="alertContainer"></div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="section-container">
            <div class="grid-5 mb-4">
                <div class="stats-card">
                    <div class="stats-number" id="totalOrders">0</div>
                    <div class="stats-label">Today's Orders</div>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stats-number" id="totalRevenue">ر.س 0</div>
                    <div class="stats-label">Today's Revenue</div>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stats-number" id="totalCustomers">0</div>
                    <div class="stats-label">Total Customers</div>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stats-number" id="lowStockItems">0</div>
                    <div class="stats-label">Low Stock Alert</div>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <div class="stats-number" id="pendingOrders">0</div>
                    <div class="stats-label">Pending Orders</div>
                </div>
            </div>

            <div class="grid-3 mb-4">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Sales Overview</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Order Status</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="orderStatusChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Top Items</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="topItemsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="text-lg font-semibold mb-3">Recent Activity</h3>
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Activity</th>
                                <th>Details</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="orders" class="section-container hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Order Management</h3>
                    <div class="flex gap-2">
                        <button onclick="showCreateOrderForm()" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i>New Order
                        </button>
                        <button onclick="refreshOrders()" class="btn btn-info btn-sm">
                            <i class="fas fa-sync"></i>Refresh
                        </button>
                        <button onclick="deleteAllOrders()" class="btn btn-danger">
                            Delete All Orders
                        </button>

                        <button onclick="exportOrdersToExcel()" class="btn btn-success">Export to Excel</button>
                        <button onclick="exportOrdersToJSON()" class="btn btn-primary">Export to JSON</button>

                    </div>
                </div>

                <!-- Create/Edit Order Form -->
                <div id="createOrderForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3" id="orderFormTitle">Create New Order</h4>
                    <input type="hidden" id="orderId"> <!-- Hidden input for order ID -->
                    <div class="grid-3 mb-4">
                        <div>
                            <input type="tel" id="orderCustomerPhone" placeholder="Customer Phone *" class="form-input">
                            <select id="orderCashier" class="form-input">
                                <option value="">Select Cashier *</option>
                            </select>
                            <input type="text" id="orderTable" placeholder="Table Number" class="form-input">
                        </div>
                        <div>
                            <select id="orderType" class="form-input">
                                <option value="dine-in">Dine In</option>
                                <option value="takeaway">Takeaway</option>
                                <option value="delivery">Delivery</option>
                            </select>
                            <input type="datetime-local" id="orderDate" class="form-input">
                            <input type="text" id="orderNotes" placeholder="Special Notes" class="form-input">
                        </div>
                        <div>
                            <div class="border rounded p-2 mb-2">
                                <h5 class="font-medium mb-2">Order Items:</h5>
                                <div id="orderItemsContainer"></div>
                                <button type="button" onclick="addOrderItem()" class="btn btn-info btn-sm">
                                    <i class="fas fa-plus"></i>Add Item
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <strong>Subtotal: <span id="orderSubtotal">ر.س 0.00</span></strong><br>
                            <strong>VAT (15%): <span id="orderVAT">ر.س 0.00</span></strong><br>
                            <strong>Total: <span id="orderTotal">ر.س 0.00</span></strong>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="createOrder()" class="btn btn-success" id="saveOrderBtn">Create Order</button>
                            <button onclick="hideCreateOrderForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Orders List -->
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Items</th>
                                <th>Subtotal</th>
                                <th>VAT</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Kitchen Display Tab -->
        <div id="kitchen" class="section-container hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Kitchen Display System</h3>
                    <div class="flex gap-2">
                        <button onclick="refreshKitchen()" class="btn btn-info btn-sm">
                            <i class="fas fa-sync"></i>Refresh
                        </button>
                        <select id="kitchenFilter" onchange="filterKitchenOrders()" class="form-input" style="width: auto; margin: 0;">
                            <option value="all">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                        </select>
                    </div>
                </div>

                <div class="grid-3" id="kitchenOrdersContainer">
                    <!-- Kitchen orders will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Menu Management Tab -->
        <div id="menu" class="section-container hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Menu Management</h3>
                    <button onclick="showAddMenuItemForm()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>Add Item
                    </button>
                </div>

                <!-- Add Menu Item Form -->
                <div id="addMenuItemForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3">Add New Menu Item</h4>
                    <div class="grid-3">
                        <div>
                            <input type="text" id="menuItemName" placeholder="Item Name *" class="form-input">
                            <input type="number" id="menuItemPrice" placeholder="Price (SAR) *" step="0.01" class="form-input">
                            <input type="number" id="menuItemCost" placeholder="Cost (SAR)" step="0.01" class="form-input">
                        </div>
                        <div>
                            <select id="menuItemCategory" class="form-input">
                                <option value="">Select Category *</option>
                                <option value="appetizers">Appetizers</option>
                                <option value="main">Main Course</option>
                                <option value="desserts">Desserts</option>
                                <option value="beverages">Beverages</option>
                            </select>
                            <input type="number" id="menuItemStock" placeholder="Initial Stock" class="form-input">
                            <select id="menuItemUnit" class="form-input">
                                <option value="pcs">Pieces</option>
                                <option value="kg">Kilograms</option>
                                <option value="liter">Liters</option>
                            </select>
                        </div>
                        <div>
                            <textarea id="menuItemDescription" placeholder="Description" class="form-input" rows="2"></textarea>
                            <input type="date" id="menuItemExpiry" class="form-input" placeholder="Expiry Date">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addMenuItem()" class="btn btn-success">Add Item</button>
                        <button onclick="hideAddMenuItemForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>
                    </div>
                </div>

                <!-- Menu Items List -->
                <div id="menuItemsList">
                    <!-- Menu items will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Inventory Management Tab -->
        <div id="inventory" class="section-container hidden">
            <div class="grid-2 mb-4">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Stock Levels</h3>
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Stock</th>
                                    <th>Unit</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="stockLevelsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Low Stock Alerts</h3>
                    <div id="lowStockAlerts">
                        <!-- Low stock alerts will be displayed here -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Purchase Orders</h3>
                    <button onclick="showCreatePurchaseOrderForm()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>New Purchase Order
                    </button>
                </div>

                <!-- Create Purchase Order Form -->
                <div id="createPurchaseOrderForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3">Create Purchase Order</h4>
                    <div class="grid-2">
                        <div>
                            <select id="poSupplier" class="form-input">
                                <option value="">Select Supplier *</option>
                            </select>
                            <input type="date" id="poDate" class="form-input">
                        </div>
                        <div>
                            <input type="text" id="poNotes" placeholder="Notes" class="form-input">
                            <div id="poItemsContainer" class="border rounded p-2">
                                <h5 class="font-medium mb-2">Items:</h5>
                                <button type="button" onclick="addPOItem()" class="btn btn-info btn-sm">
                                    <i class="fas fa-plus"></i>Add Item
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="createPurchaseOrder()" class="btn btn-success">Create Purchase Order</button>
                        <button onclick="hideCreatePurchaseOrderForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>
                    </div>
                </div>

                <!-- Purchase Orders List -->
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>PO #</th>
                                <th>Supplier</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchaseOrdersTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="section-container hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Customer Management</h3>
                    <button onclick="showAddCustomerForm()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>Add Customer
                    </button>
                </div>

                <!-- Add Customer Form -->
                <div id="addCustomerForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3">Add New Customer</h4>
                    <div class="grid-3">
                        <div>
                            <input type="text" id="customerName" placeholder="Customer Name *" class="form-input">
                            <input type="email" id="customerEmail" placeholder="Email" class="form-input">
                        </div>
                        <div>
                            <input type="tel" id="customerPhone" placeholder="Phone Number *" class="form-input">
                            <input type="date" id="customerBirthdate" class="form-input">
                        </div>
                        <div>
                            <textarea id="customerAddress" placeholder="Address" class="form-input" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addCustomer()" class="btn btn-success">Add Customer</button>
                        <button onclick="hideAddCustomerForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>
                    </div>
                </div>

                <!-- Customers List -->
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Tier</th>
                                <th>Points</th>
                                <th>Total Orders</th>
                                <th>Total Spent</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loyalty Program Tab -->
        <div id="loyalty" class="section-container hidden">
            <div class="grid-2 mb-4">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Loyalty Program Overview</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-yellow-100 rounded">
                            <span>Bronze Members</span>
                            <span id="bronzeMembersCount" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-200 rounded">
                            <span>Silver Members</span>
                            <span id="silverMembersCount" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-300 rounded">
                            <span>Gold Members</span>
                            <span id="goldMembersCount" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-300 rounded">
                            <span>Platinum Members</span>
                            <span id="platinumMembersCount" class="font-bold">0</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Points Distribution</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="loyaltyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Promotional Campaigns</h3>
                    <button onclick="showCreateCampaignForm()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>New Campaign
                    </button>
                </div>

                <!-- Create Campaign Form -->
                <div id="createCampaignForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3">Create New Campaign</h4>
                    <div class="grid-2">
                        <div>
                            <input type="text" id="campaignName" placeholder="Campaign Name *" class="form-input">
                            <textarea id="campaignDescription" placeholder="Description" class="form-input" rows="2"></textarea>
                        </div>
                        <div>
                            <input type="date" id="campaignStartDate" class="form-input">
                            <input type="date" id="campaignEndDate" class="form-input">
                            <input type="number" id="campaignDiscount" placeholder="Discount %" class="form-input">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="createCampaign()" class="btn btn-success">Create Campaign</button>
                        <button onclick="hideCreateCampaignForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>
                    </div>
                </div>

                <!-- Campaigns List -->
                <div id="campaignsList">
                    <!-- Campaigns will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Reservations Tab -->
        <div id="reservations" class="section-container hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Table Reservations</h3>
                    <button onclick="showCreateReservationForm()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>New Reservation
                    </button>
                </div>

                <!-- Create Reservation Form -->
                <div id="createReservationForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3">Create New Reservation</h4>
                    <div class="grid-3">
                        <div>
                            <input type="text" id="reservationCustomerName" placeholder="Customer Name *" class="form-input">
                            <input type="tel" id="reservationCustomerPhone" placeholder="Phone *" class="form-input">
                        </div>
                        <div>
                            <input type="datetime-local" id="reservationDateTime" class="form-input">
                            <input type="number" id="reservationPartySize" placeholder="Party Size *" class="form-input">
                        </div>
                        <div>
                            <select id="reservationTable" class="form-input">
                                <option value="">Select Table</option>
                                <option value="1">Table 1 (2 seats)</option>
                                <option value="2">Table 2 (4 seats)</option>
                                <option value="3">Table 3 (6 seats)</option>
                                <option value="4">Table 4 (8 seats)</option>
                            </select>
                            <textarea id="reservationNotes" placeholder="Special Requests" class="form-input" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="createReservation()" class="btn btn-success">Create Reservation</button>
                        <button onclick="hideCreateReservationForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>
                    </div>
                </div>

                <!-- Reservations List -->
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Party Size</th>
                                <th>Table</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Staff Management Tab -->
        <div id="staff" class="section-container hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Staff Management</h3>
                    <button onclick="showAddStaffForm()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>Add Staff
                    </button>
                </div>

                <!-- Add Staff Form -->
                <div id="addStaffForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3">Add New Staff Member</h4>
                    <div class="grid-3">
                        <div>
                            <input type="text" id="staffName" placeholder="Full Name *" class="form-input">
                            <input type="email" id="staffEmail" placeholder="Email" class="form-input">
                            <input type="tel" id="staffPhone" placeholder="Phone *" class="form-input">
                        </div>
                        <div>
                            <select id="staffRole" class="form-input">
                                <option value="">Select Role *</option>
                                <option value="cashier">Cashier</option>
                                <option value="waiter">Waiter</option>
                                <option value="chef">Chef</option>
                                <option value="manager">Manager</option>
                            </select>
                            <select id="staffShift" class="form-input">
                                <option value="">Select Shift</option>
                                <option value="morning">Morning (6AM-2PM)</option>
                                <option value="afternoon">Afternoon (2PM-10PM)</option>
                                <option value="night">Night (10PM-6AM)</option>
                            </select>
                            <input type="number" id="staffSalary" placeholder="Monthly Salary (SAR)" class="form-input">
                        </div>
                        <div>
                            <input type="date" id="staffHireDate" class="form-input">
                            <input type="text" id="staffEmployeeId" placeholder="Employee ID" class="form-input">
                            <textarea id="staffNotes" placeholder="Notes" class="form-input" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addStaff()" class="btn btn-success">Add Staff</button>
                        <button onclick="hideAddStaffForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>

                    </div>
                </div>

                <!-- Staff List -->
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Shift</th>
                                <th>Phone</th>
                                <th>Hire Date</th>
                                <th>Salary</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Suppliers Tab -->
        <div id="suppliers" class="section-container hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Supplier Management</h3>
                    <button onclick="showAddSupplierForm()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>Add Supplier
                    </button>
                </div>

                <!-- Add Supplier Form -->
                <div id="addSupplierForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold mb-3">Add New Supplier</h4>
                    <div class="grid-3">
                        <div>
                            <input type="text" id="supplierName" placeholder="Company Name *" class="form-input">
                            <input type="text" id="supplierContact" placeholder="Contact Person" class="form-input">
                            <input type="tel" id="supplierPhone" placeholder="Phone *" class="form-input">
                        </div>
                        <div>
                            <input type="email" id="supplierEmail" placeholder="Email" class="form-input">
                            <input type="text" id="supplierTaxNumber" placeholder="Tax Registration Number" class="form-input">
                            <select id="supplierCategory" class="form-input">
                                <option value="">Select Category</option>
                                <option value="food">Food Items</option>
                                <option value="beverages">Beverages</option>
                                <option value="equipment">Equipment</option>
                                <option value="supplies">Supplies</option>
                            </select>
                        </div>
                        <div>
                            <textarea id="supplierAddress" placeholder="Address" class="form-input" rows="2"></textarea>
                            <textarea id="supplierNotes" placeholder="Notes" class="form-input" rows="1"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addSupplier()" class="btn btn-success">Add Supplier</button>
                        <button onclick="hideAddSupplierForm()" class="btn" style="background: #6b7280; color: white;">Cancel</button>
                    </div>
                </div>

                <!-- Suppliers List -->
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Category</th>
                                <th>Tax Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="section-container hidden">
            <div class="grid-3 mb-4">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Daily Sales Report</h3>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="dailySales">ر.س 0.00</div>
                        <div class="text-sm text-gray-600">Today's Sales</div>
                        <button onclick="generateDailySalesReport()" class="btn btn-info btn-sm mt-2">
                            <i class="fas fa-download"></i>Generate Report
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Monthly VAT Report</h3>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="monthlyVAT">ر.س 0.00</div>
                        <div class="text-sm text-gray-600">This Month's VAT</div>
                        <button onclick="generateVATReport()" class="btn btn-info btn-sm mt-2">
                            <i class="fas fa-download"></i>Generate Report
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Profit Analysis</h3>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="monthlyProfit">ر.س 0.00</div>
                        <div class="text-sm text-gray-600">This Month's Profit</div>
                        <button onclick="generateProfitReport()" class="btn btn-info btn-sm mt-2">
                            <i class="fas fa-download"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid-2 mb-4">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Sales Trends</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Customer Analytics</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="customerAnalyticsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="text-lg font-semibold mb-3">Staff Performance</h3>
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Role</th>
                                <th>Orders Handled</th>
                                <th>Sales Generated</th>
                                <th>Average Order Value</th>
                                <th>Performance Score</th>
                            </tr>
                        </thead>
                        <tbody id="staffPerformanceTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="section-container hidden">
            <div class="grid-2">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Restaurant Information</h3>
                    <div class="space-y-3">
                        <input type="text" id="restaurantName" placeholder="Restaurant Name" class="form-input" value="My Restaurant">
                        <input type="text" id="restaurantTaxNumber" placeholder="Tax Registration Number" class="form-input">
                        <textarea id="restaurantAddress" placeholder="Address" class="form-input" rows="2"></textarea>
                        <input type="tel" id="restaurantPhone" placeholder="Phone Number" class="form-input">
                        <input type="email" id="restaurantEmail" placeholder="Email" class="form-input">
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">System Settings</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Default Language</label>
                            <select id="defaultLanguage" class="form-input">
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">VAT Rate (%)</label>
                            <input type="number" id="vatRate" class="form-input" value="15" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Low Stock Threshold</label>
                            <input type="number" id="lowStockThreshold" class="form-input" value="10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Points per SAR</label>
                            <input type="number" id="pointsPerSAR" class="form-input" value="1" step="0.1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <h3 class="text-lg font-semibold mb-3">Data Management</h3>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="exportDataJSON()" class="btn btn-success">
                        <i class="fas fa-download"></i>Export JSON
                    </button>
                    <button onclick="exportDataExcel()" class="btn btn-info">
                        <i class="fas fa-file-excel"></i>Export Excel
                    </button>
                    <button onclick="importData()" class="btn btn-warning">
                        <i class="fas fa-upload"></i>Import Data
                    </button>
                    <button onclick="backupData()" class="btn btn-primary">
                        <i class="fas fa-database"></i>Backup Data
                    </button>
                    <button onclick="clearAllData()" class="btn btn-danger">
                        <i class="fas fa-trash"></i>Clear All Data
                    </button>
                </div>
            </div>

            <div class="card mt-4">
                <h3 class="text-lg font-semibold mb-3">System Information</h3>
                <div class="grid-2">
                    <div>
                        <p><strong>Version:</strong> 2.0.0</p>
                        <p><strong>Last Backup:</strong> <span id="lastBackup">Never</span></p>
                        <p><strong>Total Orders:</strong> <span id="totalOrdersCount">0</span></p>
                    </div>
                    <div>
                        <p><strong>Total Revenue:</strong> <span id="totalRevenueAmount">ر.س 0.00</span></p>
                        <p><strong>Active Customers:</strong> <span id="activeCustomersCount">0</span></p>
                        <p><strong>Menu Items:</strong> <span id="menuItemsCount">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Receipt</h3>
                <button onclick="closeReceiptModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="receiptContent" class="receipt-container">
                <!-- Receipt content will be generated here -->
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="printReceipt()" class="btn btn-primary flex-1">
                    <i class="fas fa-print"></i>Print
                </button>
                <button onclick="emailReceipt()" class="btn btn-info flex-1">
                    <i class="fas fa-envelope"></i>Email
                </button>
            </div>
        </div>
    </div>

    <script>

        // Enhanced Data Manager with all new features
        class EnhancedDataManager {
            constructor() {
                this.storageKeys = {
                    menuItems: 'restaurant_menu_items',
                    orders: 'restaurant_orders',
                    customers: 'restaurant_customers',
                    staff: 'restaurant_staff',
                    suppliers: 'restaurant_suppliers',
                    reservations: 'restaurant_reservations',
                    purchaseOrders: 'restaurant_purchase_orders',
                    campaigns: 'restaurant_campaigns',
                    settings: 'restaurant_settings',
                    branches: 'restaurant_branches',
                    orderCounter: 'restaurant_order_counter'
                };
                this.currentBranch = 'main';
                this.currentLanguage = 'en';
                this.vatRate = 0.15; // 15% VAT for KSA
                this.charts = {}; // To store chart instances for proper destruction
                this.initializeData();
                this.startRealTimeUpdates();
            }

            initializeData() {
                // Initialize with sample data if no data exists
                if (!this.getMenuItems().length) {
                    this.saveData(this.storageKeys.menuItems, this.getSampleMenuItems());
                }
                if (!this.getStaff().length) {
                    this.saveData(this.storageKeys.staff, this.getSampleStaff());
                }
                if (!this.getCustomers().length) {
                    this.saveData(this.storageKeys.customers, this.getSampleCustomers());
                }
                if (!this.getSuppliers().length) {
                    this.saveData(this.storageKeys.suppliers, this.getSampleSuppliers());
                }
                if (!localStorage.getItem(this.storageKeys.orderCounter)) {
                    this.saveOrderCounter(1000); // Start from 1000 for KSA compliance
                }
                this.initializeSettings();
            }

            initializeSettings() {
                const defaultSettings = {
                    restaurantName: 'My Restaurant',
                    restaurantTaxNumber: '',
                    restaurantAddress: '',
                    restaurantPhone: '',
                    restaurantEmail: '',
                    defaultLanguage: 'en',
                    vatRate: 15,
                    lowStockThreshold: 10,
                    pointsPerSAR: 1
                };

                if (!localStorage.getItem(this.storageKeys.settings)) {
                    this.saveData(this.storageKeys.settings, defaultSettings);
                }
                // Load settings and update vatRate
                const settings = this.getSettings();
                this.vatRate = (settings.vatRate || 15) / 100;
            }

            startRealTimeUpdates() {
                // Update dashboard every 30 seconds
                setInterval(() => {
                    this.updateDashboard();
                    this.updateKitchenDisplay();
                }, 30000);
            }

            saveData(key, data) {
                try {
                    const dataWithMetadata = {
                        data: data,
                        timestamp: new Date().toISOString(),
                        branch: this.currentBranch,
                        version: '2.0'
                    };
                    localStorage.setItem(key, JSON.stringify(dataWithMetadata));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.showAlert('Error saving data. Storage might be full.', 'error');
                    return false;
                }
            }

            getData(key) {
                try {
                    const stored = localStorage.getItem(key);
                    if (!stored) return [];
                    const parsed = JSON.parse(stored);
                    return parsed.data || parsed;
                } catch (error) {
                    console.error('Error retrieving data:', error);
                    return [];
                }
            }

            // Order Counter Management with KSA compliance
            getOrderCounter() {
                try {
                    return parseInt(localStorage.getItem(this.storageKeys.orderCounter)) || 1000;
                } catch {
                    return 1000;
                }
            }

            saveOrderCounter(counter) {
                localStorage.setItem(this.storageKeys.orderCounter, counter.toString());
            }

            getNextOrderNumber() {
                const current = this.getOrderCounter();
                this.saveOrderCounter(current + 1);
                return current;
            }

            // Data Getters
            getMenuItems() { return this.getData(this.storageKeys.menuItems); }
            getOrders() { return this.getData(this.storageKeys.orders); }
            getCustomers() { return this.getData(this.storageKeys.customers); }
            getStaff() { return this.getData(this.storageKeys.staff); }
            getSuppliers() { return this.getData(this.storageKeys.suppliers); }
            getReservations() { return this.getData(this.storageKeys.reservations); }
            getPurchaseOrders() { return this.getData(this.storageKeys.purchaseOrders); }
            getCampaigns() { return this.getData(this.storageKeys.campaigns); }
            getSettings() {
                try {
                    const stored = localStorage.getItem(this.storageKeys.settings);
                    if (!stored) return {};
                    const parsed = JSON.parse(stored);
                    return parsed.data || parsed;
                } catch (error) {
                    console.error('Error retrieving settings:', error);
                    return {};
                }
            }

            // Enhanced Order Management with VAT
            addOrder(order) {
                const orders = this.getOrders();
                order.id = Date.now().toString();
                order.orderNumber = this.getNextOrderNumber();
                order.createdAt = order.orderDate || new Date().toISOString();
                order.status = order.status || 'pending';
                order.branch = this.currentBranch;

                // Calculate VAT and totals
                order.subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                order.vatAmount = order.subtotal * this.vatRate;
                order.total = order.subtotal + order.vatAmount;

                // Check and reduce stock
                let menuItems = this.getMenuItems();
                let stockReducedSuccessfully = true;

                order.items.forEach(orderedItem => {
                    const itemIndex = menuItems.findIndex(mi => mi.id === orderedItem.id);
                    if (itemIndex !== -1) {
                        // Only reduce stock for new orders, not updates
                        if (!order.isUpdate) {
                            if (menuItems[itemIndex].stock >= orderedItem.quantity) {
                                menuItems[itemIndex].stock -= orderedItem.quantity;
                            } else {
                                this.showAlert(`Insufficient stock for ${orderedItem.name}`, 'error');
                                stockReducedSuccessfully = false;
                            }
                        }
                    }
                });

                if (stockReducedSuccessfully) {
                    this.saveData(this.storageKeys.menuItems, menuItems);
                    orders.push(order);

                    // Update customer loyalty points
                    this.updateCustomerLoyalty(order.customerPhone, order.total);

                    return this.saveData(this.storageKeys.orders, orders);
                }
                return false;
            }

            updateOrder(updatedOrder) {
                const orders = this.getOrders();
                const orderIndex = orders.findIndex(o => o.id === updatedOrder.id);

                if (orderIndex === -1) {
                    this.showAlert('Order not found for update.', 'error');
                    return false;
                }

                // Revert old stock before applying new stock changes
                const oldOrder = orders[orderIndex];
                let menuItems = this.getMenuItems();

                oldOrder.items.forEach(oldItem => {
                    const itemIndex = menuItems.findIndex(mi => mi.id === oldItem.id);
                    if (itemIndex !== -1) {
                        menuItems[itemIndex].stock += oldItem.quantity; // Return old quantity
                    }
                });

                // Calculate new VAT and totals
                updatedOrder.subtotal = updatedOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                updatedOrder.vatAmount = updatedOrder.subtotal * this.vatRate;
                updatedOrder.total = updatedOrder.subtotal + updatedOrder.vatAmount;
                updatedOrder.updatedAt = new Date().toISOString();

                // Check and reduce stock for updated items
                let stockReducedSuccessfully = true;
                updatedOrder.items.forEach(newItem => {
                    const itemIndex = menuItems.findIndex(mi => mi.id === newItem.id);
                    if (itemIndex !== -1) {
                        if (menuItems[itemIndex].stock >= newItem.quantity) {
                            menuItems[itemIndex].stock -= newItem.quantity;
                        } else {
                            this.showAlert(`Insufficient stock for ${newItem.name}`, 'error');
                            stockReducedSuccessfully = false;
                        }
                    }
                });

                if (stockReducedSuccessfully) {
                    this.saveData(this.storageKeys.menuItems, menuItems);
                    orders[orderIndex] = updatedOrder;

                    // Update customer loyalty points (recalculate based on new total)
                    this.updateCustomerLoyalty(updatedOrder.customerPhone, updatedOrder.total, oldOrder.total);

                    return this.saveData(this.storageKeys.orders, orders);
                } else {
                    // If stock reduction failed, revert stock changes
                    oldOrder.items.forEach(oldItem => {
                        const itemIndex = menuItems.findIndex(mi => mi.id === oldItem.id);
                        if (itemIndex !== -1) {
                            menuItems[itemIndex].stock -= oldItem.quantity; // Re-reduce old quantity
                        }
                    });
                    this.saveData(this.storageKeys.menuItems, menuItems);
                    return false;
                }
            }


            updateCustomerLoyalty(phone, newOrderTotal, oldOrderTotal = 0) {
                if (!phone) return;

                const customers = this.getCustomers();
                const customerIndex = customers.findIndex(c => c.phone === phone);

                if (customerIndex !== -1) {
                    // Adjust points and total spent for updates
                    customers[customerIndex].loyaltyPoints = (customers[customerIndex].loyaltyPoints || 0) - Math.floor(oldOrderTotal * (this.getSettings().pointsPerSAR || 1)) + Math.floor(newOrderTotal * (this.getSettings().pointsPerSAR || 1));
                    customers[customerIndex].totalSpent = (customers[customerIndex].totalSpent || 0) - oldOrderTotal + newOrderTotal;

                    // For total orders, only increment if it's a new order, not an update
                    if (oldOrderTotal === 0) { // This indicates a new order
                        customers[customerIndex].totalOrders = (customers[customerIndex].totalOrders || 0) + 1;
                    }

                    // Ensure points don't go negative
                    if (customers[customerIndex].loyaltyPoints < 0) customers[customerIndex].loyaltyPoints = 0;

                    // Update loyalty tier
                    this.updateLoyaltyTier(customers[customerIndex]);

                    this.saveData(this.storageKeys.customers, customers);
                } else if (oldOrderTotal === 0) { // Only add new customer if it's a new order
                    const newCustomer = {
                        id: Date.now().toString(),
                        name: 'Unknown Customer', // Or prompt for name
                        phone: phone,
                        email: '',
                        address: '',
                        birthdate: '',
                        totalOrders: 1,
                        totalSpent: newOrderTotal,
                        loyaltyPoints: Math.floor(newOrderTotal * (this.getSettings().pointsPerSAR || 1)),
                        loyaltyTier: 'bronze',
                        createdAt: new Date().toISOString()
                    };
                    customers.push(newCustomer);
                    this.updateLoyaltyTier(newCustomer); // Ensure tier is set for new customer
                    this.saveData(this.storageKeys.customers, customers);
                }
            }

            updateLoyaltyTier(customer) {
                const points = customer.loyaltyPoints || 0;
                if (points >= 5000) customer.loyaltyTier = 'platinum';
                else if (points >= 2000) customer.loyaltyTier = 'gold';
                else if (points >= 500) customer.loyaltyTier = 'silver';
                else customer.loyaltyTier = 'bronze';
            }

            // Receipt Generation with QR Code
            async generateReceipt(orderId) {
                const order = this.getOrders().find(o => o.id === orderId);
                if (!order) return null;

                const settings = this.getSettings();
                const customer = this.getCustomers().find(c => c.phone === order.customerPhone);

                // Create QR code data
                const qrData = {
                    orderId: order.id,
                    orderNumber: order.orderNumber,
                    total: order.total,
                    date: order.createdAt,
                    verificationUrl: `${window.location.origin}/verify-order?id=${order.id}`
                };

                // Generate QR code
                let qrCodeDataURL = '';
                try {
                    qrCodeDataURL = await QRCode.toDataURL(JSON.stringify(qrData), { errorCorrectionLevel: 'H', margin: 1, scale: 4 });
                } catch (err) {
                    console.error('QR Code generation failed:', err);
                    qrCodeDataURL = ''; // Fallback if QR code generation fails
                }


                // Create receipt HTML
                const receiptHTML = `
                <div class="receipt-container">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold">${settings.restaurantName || 'Restaurant'}</h2>
                        <p>${settings.restaurantAddress || ''}</p>
                        <p>Tel: ${settings.restaurantPhone || ''}</p>
                        <p>Tax No: ${settings.restaurantTaxNumber || ''}</p>
                    </div>

                    <div class="border-t border-b py-2 mb-4">
                        <div class="flex justify-between">
                            <span>Order #:</span>
                            <span>${order.orderNumber}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Date:</span>
                            <span>${new Date(order.createdAt).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Cashier:</span>
                            <span>${order.cashier || 'N/A'}</span>
                        </div>
                        ${order.table ? `<div class="flex justify-between"><span>Table:</span><span>${order.table}</span></div>` : ''}
                    </div>

                    <div class="mb-4">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left">Item</th>
                                    <th class="text-right">Qty</th>
                                    <th class="text-right">Price</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td class="text-right">${item.quantity}</td>
                                        <td class="text-right">ر.س ${item.price.toFixed(2)}</td>
                                        <td class="text-right">ر.س ${(item.price * item.quantity).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="border-t pt-2 mb-4">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span>ر.س ${order.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>VAT (${(this.vatRate * 100)}%):</span>
                            <span>ر.س ${order.vatAmount.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total:</span>
                            <span>ر.س ${order.total.toFixed(2)}</span>
                        </div>
                    </div>

                    ${customer && customer.loyaltyPoints ? `
                        <div class="mb-4 text-center">
                            <p>Loyalty Points Earned: ${Math.floor(order.total * (this.getSettings().pointsPerSAR || 1))}</p>
                            <p>Total Points: ${customer.loyaltyPoints}</p>
                            <p>Tier: ${customer.loyaltyTier?.toUpperCase() || 'BRONZE'}</p>
                        </div>
                    ` : ''}

                    ${qrCodeDataURL ? `
                        <div class="qr-code mb-4">
                            <img src="${qrCodeDataURL}" alt="Order QR Code" style="width: 100px; height: 100px; margin: 0 auto;">
                            <p class="text-xs text-center mt-2">Scan for order verification</p>
                        </div>
                    ` : ''}

                    <div class="text-center text-sm">
                        <p>Thank you for your visit!</p>
                        <p>Visit us again soon!</p>
                    </div>
                </div>
            `;

                return receiptHTML;
            }

            // Sample Data
            getSampleMenuItems() {
                return [
                    {
                        id: '1',
                        name: 'Kabsa Chicken',
                        price: 25.00,
                        cost: 12.50,
                        category: 'main',
                        description: 'Traditional Saudi rice dish with chicken',
                        stock: 20,
                        unit: 'pcs',
                        expiryDate: '2024-12-31',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'Arabic Coffee',
                        price: 8.00,
                        cost: 2.00,
                        category: 'beverages',
                        description: 'Traditional Arabic coffee',
                        stock: 50,
                        unit: 'pcs',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '3',
                        name: 'Hummus',
                        price: 12.00,
                        cost: 4.00,
                        category: 'appetizers',
                        description: 'Fresh hummus with bread',
                        stock: 15,
                        unit: 'pcs',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            getSampleCustomers() {
                return [
                    {
                        id: '1',
                        name: 'Ahmed Al-Rashid',
                        phone: '+966501234567',
                        email: 'ahmed@example.com',
                        address: 'Riyadh, Saudi Arabia',
                        totalOrders: 5,
                        totalSpent: 150.00,
                        loyaltyPoints: 150,
                        loyaltyTier: 'bronze',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            getSampleStaff() {
                return [
                    {
                        id: '1',
                        name: 'Fatima Al-Zahra',
                        role: 'cashier',
                        phone: '+966507654321',
                        email: 'fatima@restaurant.com',
                        employeeId: 'EMP001',
                        shift: 'morning',
                        salary: 4000,
                        hireDate: new Date().toISOString(),
                        active: true,
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            getSampleSuppliers() {
                return [
                    {
                        id: '1',
                        name: 'Al-Rashid Food Supplies',
                        contact: 'Mohammed Al-Rashid',
                        phone: '+966501111111',
                        email: 'info@rashidfood.com',
                        category: 'food',
                        taxNumber: '310123456789003',
                        address: 'Riyadh, Saudi Arabia',
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            // Utility methods
            showAlert(message, type = 'info') {
                const alertContainer = document.getElementById('alertContainer');
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="float-right font-bold">&times;</button>
            `;
                alertContainer.appendChild(alertDiv);

                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            formatCurrency(amount) {
                return `ر.س ${amount.toFixed(2)}`;
            }

            updateDashboard() {
                const orders = this.getOrders();
                const customers = this.getCustomers();
                const menuItems = this.getMenuItems();
                const settings = this.getSettings();

                const today = new Date().toDateString();
                const todayOrders = orders.filter(o => new Date(o.createdAt).toDateString() === today);
                const todayRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
                const lowStockItems = menuItems.filter(item => item.stock <= (settings.lowStockThreshold || 10));
                const pendingOrders = orders.filter(o => o.status === 'pending');

                document.getElementById('totalOrders').textContent = todayOrders.length;
                document.getElementById('totalRevenue').textContent = this.formatCurrency(todayRevenue);
                document.getElementById('totalCustomers').textContent = customers.length;
                document.getElementById('lowStockItems').textContent = lowStockItems.length;
                document.getElementById('pendingOrders').textContent = pendingOrders.length;

                // Update System Information in Settings tab
                document.getElementById('totalOrdersCount').textContent = orders.length;
                document.getElementById('totalRevenueAmount').textContent = this.formatCurrency(orders.reduce((sum, o) => sum + o.total, 0));
                document.getElementById('activeCustomersCount').textContent = customers.length; // Assuming all are active
                document.getElementById('menuItemsCount').textContent = menuItems.length;
                const lastBackup = localStorage.getItem('lastBackupTimestamp');
                document.getElementById('lastBackup').textContent = lastBackup ? new Date(lastBackup).toLocaleString() : 'Never';


                this.updateCharts();
                this.updateRecentActivity();
            }

            updateRecentActivity() {
                const tbody = document.getElementById('recentActivityTable');
                if (!tbody) return;

                const orders = this.getOrders().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5); // Last 5 orders

                tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${new Date(order.createdAt).toLocaleTimeString()}</td>
                    <td>New Order</td>
                    <td>Order #${order.orderNumber} by ${order.customerPhone}</td>
                    <td>${this.formatCurrency(order.total)}</td>
                </tr>
            `).join('');
            }

            destroyChart(chartId) {
                if (this.charts[chartId]) {
                    this.charts[chartId].destroy();
                    delete this.charts[chartId];
                }
            }

            updateCharts() {
                this.updateSalesChart();
                this.updateOrderStatusChart();
                this.updateTopItemsChart();
                this.updateLoyaltyChart(); // For loyalty tab
                this.updateSalesTrendChart(); // For reports tab
                this.updateCustomerAnalyticsChart(); // For reports tab
            }

            updateSalesChart() {
                const ctx = document.getElementById('salesChart')?.getContext('2d');
                if (!ctx) return;

                this.destroyChart('salesChart'); // Destroy existing chart

                const orders = this.getOrders();
                const last7Days = [];
                const salesData = [];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toDateString());

                    const dayOrders = orders.filter(o => new Date(o.createdAt).toDateString() === date.toDateString());
                    const dayTotal = dayOrders.reduce((sum, o) => sum + o.total, 0);
                    salesData.push(dayTotal);
                }

                this.charts.salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => new Date(d).toLocaleDateString()),
                        datasets: [{
                            label: 'Sales (SAR)',
                            data: salesData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            updateOrderStatusChart() {
                const ctx = document.getElementById('orderStatusChart')?.getContext('2d');
                if (!ctx) return;

                this.destroyChart('orderStatusChart'); // Destroy existing chart

                const orders = this.getOrders();
                const statusCounts = {
                    pending: orders.filter(o => o.status === 'pending').length,
                    preparing: orders.filter(o => o.status === 'preparing').length,
                    ready: orders.filter(o => o.status === 'ready').length,
                    delivered: orders.filter(o => o.status === 'delivered').length
                };

                this.charts.orderStatusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pending', 'Preparing', 'Ready', 'Delivered'],
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#6b7280']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            updateTopItemsChart() {
                const ctx = document.getElementById('topItemsChart')?.getContext('2d');
                if (!ctx) return;

                this.destroyChart('topItemsChart'); // Destroy existing chart

                const orders = this.getOrders();
                const itemCounts = {};

                orders.forEach(order => {
                    order.items.forEach(item => {
                        itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
                    });
                });

                const sortedItems = Object.entries(itemCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                this.charts.topItemsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedItems.map(item => item[0]),
                        datasets: [{
                            label: 'Quantity Sold',
                            data: sortedItems.map(item => item[1]),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            updateKitchenDisplay() {
                const container = document.getElementById('kitchenOrdersContainer');
                if (!container) return;

                const filter = document.getElementById('kitchenFilter')?.value || 'all';
                let orders = this.getOrders();

                if (filter !== 'all') {
                    orders = orders.filter(o => o.status === filter);
                } else {
                    orders = orders.filter(o => ['pending', 'preparing'].includes(o.status));
                }

                // Sort by creation time, oldest first
                orders.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

                container.innerHTML = orders.map(order => {
                    const urgentClass = this.isOrderUrgent(order) ? 'urgent' : '';
                    return `
                    <div class="kitchen-order ${urgentClass}">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg">Order #${order.orderNumber}</h4>
                            <span class="text-sm">${new Date(order.createdAt).toLocaleTimeString()}</span>
                        </div>
                        <div class="mb-3">
                            ${order.items.map(item => `
                                <div class="flex justify-between">
                                    <span>${item.quantity}x ${item.name}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex gap-2 mt-2">
                            ${order.status === 'pending' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'preparing')"
                                        class="btn btn-warning btn-sm flex-1">Start Preparing</button>
                            ` : ''}
                            ${order.status === 'preparing' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'ready')"
                                        class="btn btn-success btn-sm flex-1">Mark Ready</button>
                            ` : ''}
                            ${order.status === 'ready' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'delivered')"
                                        class="btn btn-info btn-sm flex-1">Mark Delivered</button>
                            ` : ''}
                        </div>
                    </div>
                `;
                }).join('');
            }

            isOrderUrgent(order) {
                const orderTime = new Date(order.createdAt);
                const now = new Date();
                const diffMinutes = (now - orderTime) / (1000 * 60);
                return diffMinutes > 15 && order.status !== 'ready' && order.status !== 'delivered'; // Orders older than 15 minutes and not ready/delivered are urgent
            }

            // Export/Import functionality
            exportDataJSON() {
                const allData = {
                    menuItems: this.getMenuItems(),
                    orders: this.getOrders(),
                    customers: this.getCustomers(),
                    staff: this.getStaff(),
                    suppliers: this.getSuppliers(),
                    reservations: this.getReservations(),
                    purchaseOrders: this.getPurchaseOrders(),
                    campaigns: this.getCampaigns(),
                    settings: this.getSettings(),
                    orderCounter: this.getOrderCounter(),
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };

                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `restaurant_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                this.showAlert('Data exported successfully!', 'success');
            }

            importAllData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    if (data.menuItems) this.saveData(this.storageKeys.menuItems, data.menuItems);
                    if (data.orders) this.saveData(this.storageKeys.orders, data.orders);
                    if (data.customers) this.saveData(this.storageKeys.customers, data.customers);
                    if (data.staff) this.saveData(this.storageKeys.staff, data.staff);
                    if (data.suppliers) this.saveData(this.storageKeys.suppliers, data.suppliers);
                    if (data.reservations) this.saveData(this.storageKeys.reservations, data.reservations);
                    if (data.purchaseOrders) this.saveData(this.storageKeys.purchaseOrders, data.purchaseOrders);
                    if (data.campaigns) this.saveData(this.storageKeys.campaigns, data.campaigns);
                    if (data.settings) this.saveData(this.storageKeys.settings, data.settings);
                    if (data.orderCounter) this.saveOrderCounter(data.orderCounter);

                    this.initializeSettings(); // Re-initialize settings to apply imported VAT rate etc.
                    return true;
                } catch (error) {
                    console.error('Error importing data:', error);
                    return false;
                }
            }

            clearAllData() {
                for (const key in this.storageKeys) {
                    localStorage.removeItem(this.storageKeys[key]);
                }
                localStorage.removeItem('lastBackupTimestamp'); // Clear backup timestamp
                this.initializeData(); // Re-initialize with sample data
                this.showAlert('All data cleared successfully!', 'success');
            }

            // Inventory Management
            updateInventoryDisplay() {
                const stockLevelsTable = document.getElementById('stockLevelsTable');
                const lowStockAlertsDiv = document.getElementById('lowStockAlerts');
                if (!stockLevelsTable || !lowStockAlertsDiv) return;

                const menuItems = this.getMenuItems();
                const lowStockThreshold = this.getSettings().lowStockThreshold || 10;

                stockLevelsTable.innerHTML = menuItems.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.stock}</td>
                    <td>${item.unit || 'pcs'}</td>
                    <td><span class="status-badge ${item.stock <= lowStockThreshold ? 'status-pending' : 'status-ready'}">
                        ${item.stock <= lowStockThreshold ? 'Low' : 'Sufficient'}
                    </span></td>
                    <td>
                        <button onclick="promptUpdateStock('${item.id}', '${item.name}')" class="btn btn-info btn-sm">
                            <i class="fas fa-plus"></i> Add Stock
                        </button>
                    </td>
                </tr>
            `).join('');

                const lowStockItems = menuItems.filter(item => item.stock <= lowStockThreshold);
                if (lowStockItems.length > 0) {
                    lowStockAlertsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h4 class="font-bold mb-2">Low Stock Alerts:</h4>
                        <ul>
                            ${lowStockItems.map(item => `<li>${item.name} has only ${item.stock} ${item.unit || 'pcs'} left.</li>`).join('')}
                        </ul>
                    </div>
                `;
                } else {
                    lowStockAlertsDiv.innerHTML = `<div class="alert alert-success">No low stock items.</div>`;
                }
            }

            updateStock(itemId, quantity) {
                const menuItems = this.getMenuItems();
                const itemIndex = menuItems.findIndex(item => item.id === itemId);
                if (itemIndex !== -1) {
                    menuItems[itemIndex].stock += quantity;
                    this.saveData(this.storageKeys.menuItems, menuItems);
                    this.showAlert(`Stock for ${menuItems[itemIndex].name} updated by ${quantity}.`, 'success');
                    this.updateInventoryDisplay();
                    this.updateDashboard();
                } else {
                    this.showAlert('Item not found.', 'error');
                }
            }

            // Purchase Order Management
            addPurchaseOrder(po) {
                const purchaseOrders = this.getPurchaseOrders();
                po.id = Date.now().toString();
                po.createdAt = new Date().toISOString();
                po.status = 'pending'; // Default status
                purchaseOrders.push(po);
                return this.saveData(this.storageKeys.purchaseOrders, purchaseOrders);
            }

            updatePurchaseOrdersDisplay() {
                const tbody = document.getElementById('purchaseOrdersTable');
                if (!tbody) return;

                const purchaseOrders = this.getPurchaseOrders().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                const suppliers = this.getSuppliers();

                tbody.innerHTML = purchaseOrders.map(po => {
                    const supplier = suppliers.find(s => s.id === po.supplierId);
                    const total = po.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    return `
                    <tr>
                        <td>#${po.id.substring(0, 6)}</td>
                        <td>${supplier ? supplier.name : 'N/A'}</td>
                        <td>${new Date(po.createdAt).toLocaleDateString()}</td>
                        <td>${po.items.length} items</td>
                        <td>${this.formatCurrency(total)}</td>
                        <td><span class="status-badge status-${po.status}">${po.status}</span></td>
                        <td>
                            <button onclick="updatePurchaseOrderStatus('${po.id}', 'received')" class="btn btn-success btn-sm">
                                <i class="fas fa-check"></i> Receive
                            </button>
                            <button onclick="deletePurchaseOrder('${po.id}')" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            // Customer Loyalty
            updateLoyaltyDisplay() {
                const customers = this.getCustomers();
                const bronze = customers.filter(c => c.loyaltyTier === 'bronze').length;
                const silver = customers.filter(c => c.loyaltyTier === 'silver').length;
                const gold = customers.filter(c => c.loyaltyTier === 'gold').length;
                const platinum = customers.filter(c => c.loyaltyTier === 'platinum').length;

                document.getElementById('bronzeMembersCount').textContent = bronze;
                document.getElementById('silverMembersCount').textContent = silver;
                document.getElementById('goldMembersCount').textContent = gold;
                document.getElementById('platinumMembersCount').textContent = platinum;

                this.updateLoyaltyChart();
                this.updateCampaignsDisplay();
            }

            updateLoyaltyChart() {
                const ctx = document.getElementById('loyaltyChart')?.getContext('2d');
                if (!ctx) return;

                this.destroyChart('loyaltyChart');

                const customers = this.getCustomers();
                const tierCounts = {
                    bronze: customers.filter(c => c.loyaltyTier === 'bronze').length,
                    silver: customers.filter(c => c.loyaltyTier === 'silver').length,
                    gold: customers.filter(c => c.loyaltyTier === 'gold').length,
                    platinum: customers.filter(c => c.loyaltyTier === 'platinum').length,
                };

                this.charts.loyaltyChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Bronze', 'Silver', 'Gold', 'Platinum'],
                        datasets: [{
                            data: Object.values(tierCounts),
                            backgroundColor: ['#cd7f32', '#c0c0c0', '#ffd700', '#e5e4e2']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            addCampaign(campaign) {
                const campaigns = this.getCampaigns();
                campaign.id = Date.now().toString();
                campaign.createdAt = new Date().toISOString();
                campaigns.push(campaign);
                return this.saveData(this.storageKeys.campaigns, campaigns);
            }

            updateCampaignsDisplay() {
                const container = document.getElementById('campaignsList');
                if (!container) return;

                const campaigns = this.getCampaigns().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                container.innerHTML = campaigns.map(campaign => `
                <div class="card mb-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg">${campaign.name}</h4>
                            <p class="text-gray-600 text-sm">${campaign.description || 'No description'}</p>
                            <div class="flex items-center gap-4 mt-2">
                                <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">Discount: ${campaign.discount || 0}%</span>
                                <span class="text-sm text-gray-500">Starts: ${new Date(campaign.startDate).toLocaleDateString()}</span>
                                <span class="text-sm text-gray-500">Ends: ${new Date(campaign.endDate).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="deleteCampaign('${campaign.id}')" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            }

            // Reservations
            addReservation(reservation) {
                const reservations = this.getReservations();
                reservation.id = Date.now().toString();
                reservation.createdAt = new Date().toISOString();
                reservation.status = 'confirmed'; // Default status
                reservations.push(reservation);
                return this.saveData(this.storageKeys.reservations, reservations);
            }

            updateReservationsDisplay() {
                const tbody = document.getElementById('reservationsTable');
                if (!tbody) return;

                const reservations = this.getReservations().sort((a, b) => new Date(a.reservationDateTime) - new Date(b.reservationDateTime));

                tbody.innerHTML = reservations.map(res => `
                <tr>
                    <td>${new Date(res.reservationDateTime).toLocaleString()}</td>
                    <td>${res.customerName}</td>
                    <td>${res.customerPhone}</td>
                    <td>${res.partySize}</td>
                    <td>${res.table ? `Table ${res.table}` : 'Any'}</td>
                    <td><span class="status-badge status-${res.status}">${res.status}</span></td>
                    <td>
                        <button onclick="updateReservationStatus('${res.id}', 'completed')" class="btn btn-success btn-sm">
                            <i class="fas fa-check"></i> Complete
                        </button>
                        <button onclick="deleteReservation('${res.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            }

            // Staff Management
            addStaffMember(staff) {
                const staffList = this.getStaff();
                staff.id = Date.now().toString();
                staff.createdAt = new Date().toISOString();
                staff.active = true; // Default status
                staffList.push(staff);
                return this.saveData(this.storageKeys.staff, staffList);
            }

            updateStaffDisplay() {
                const tbody = document.getElementById('staffTable');
                if (!tbody) return;

                const staffList = this.getStaff().sort((a, b) => a.name.localeCompare(b.name));

                tbody.innerHTML = staffList.map(member => `
                <tr>
                    <td>${member.name}</td>
                    <td>${member.role}</td>
                    <td>${member.shift || 'N/A'}</td>
                    <td>${member.phone}</td>
                    <td>${new Date(member.hireDate).toLocaleDateString()}</td>
                    <td>${this.formatCurrency(member.salary || 0)}</td>
                    <td><span class="status-badge ${member.active ? 'status-ready' : 'status-delivered'}">
                        ${member.active ? 'Active' : 'Inactive'}
                    </span></td>
                    <td>
                        <button onclick="toggleStaffStatus('${member.id}')" class="btn btn-${member.active ? 'warning' : 'success'} btn-sm">
                            <i class="fas fa-${member.active ? 'user-slash' : 'user-check'}"></i> ${member.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button onclick="deleteStaffMember('${member.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                          <button onclick="editStaff('${member.id}')" class="btn btn-warning btn-sm">
          <i class="fas fa-edit"></i>
      </button>


                    </td>
                </tr>
            `).join('');

                // Update cashier options for order creation
                loadCashierOptions();
            }

            // Supplier Management
            addSupplier(supplier) {
                const suppliers = this.getSuppliers();
                supplier.id = Date.now().toString();
                supplier.createdAt = new Date().toISOString();
                suppliers.push(supplier);
                return this.saveData(this.storageKeys.suppliers, suppliers);
            }

            updateSuppliersDisplay() {
                const tbody = document.getElementById('suppliersTable');
                if (!tbody) return;

                const suppliers = this.getSuppliers().sort((a, b) => a.name.localeCompare(b.name));

                tbody.innerHTML = suppliers.map(supplier => `
                <tr>
                    <td>${supplier.name}</td>
                    <td>${supplier.contact || 'N/A'}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email || 'N/A'}</td>
                    <td>${supplier.category || 'N/A'}</td>
                    <td>${supplier.taxNumber || 'N/A'}</td>
                    <td>
                        <button onclick="editSupplier('${supplier.id}')" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSupplier('${supplier.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

                // Update supplier options for purchase orders
                loadSupplierOptions();
            }

            // Reports
            updateReportsDisplay() {
                const orders = this.getOrders();
                const menuItems = this.getMenuItems();
                const staff = this.getStaff();

                // Daily Sales
                const today = new Date().toDateString();
                const dailySales = orders.filter(o => new Date(o.createdAt).toDateString() === today).reduce((sum, o) => sum + o.total, 0);
                document.getElementById('dailySales').textContent = this.formatCurrency(dailySales);

                // Monthly VAT
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyVAT = orders.filter(o => {
                    const orderDate = new Date(o.createdAt);
                    return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                }).reduce((sum, o) => sum + o.vatAmount, 0);
                document.getElementById('monthlyVAT').textContent = this.formatCurrency(monthlyVAT);

                // Monthly Profit (simplified: Revenue - Cost of Goods Sold)
                let monthlyRevenue = 0;
                let monthlyCostOfGoodsSold = 0;
                orders.filter(o => {
                    const orderDate = new Date(o.createdAt);
                    return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                }).forEach(order => {
                    monthlyRevenue += order.total;
                    order.items.forEach(item => {
                        const menuItem = menuItems.find(mi => mi.id === item.id);
                        if (menuItem) {
                            monthlyCostOfGoodsSold += (menuItem.cost || 0) * item.quantity;
                        }
                    });
                });
                document.getElementById('monthlyProfit').textContent = this.formatCurrency(monthlyRevenue - monthlyCostOfGoodsSold);

                this.updateSalesTrendChart();
                this.updateCustomerAnalyticsChart();
                this.updateStaffPerformanceTable();
            }

            updateSalesTrendChart() {
                const ctx = document.getElementById('salesTrendChart')?.getContext('2d');
                if (!ctx) return;

                this.destroyChart('salesTrendChart');

                const orders = this.getOrders();
                const salesByMonth = {};

                orders.forEach(order => {
                    const date = new Date(order.createdAt);
                    const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    salesByMonth[monthYear] = (salesByMonth[monthYear] || 0) + order.total;
                });

                const sortedMonths = Object.keys(salesByMonth).sort();
                const labels = sortedMonths.map(my => {
                    const [year, month] = my.split('-');
                    return new Date(year, month - 1).toLocaleString('default', { month: 'short', year: 'numeric' });
                });
                const data = sortedMonths.map(my => salesByMonth[my]);

                this.charts.salesTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Sales (SAR)',
                            data: data,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            updateCustomerAnalyticsChart() {
                const ctx = document.getElementById('customerAnalyticsChart')?.getContext('2d');
                if (!ctx) return;

                this.destroyChart('customerAnalyticsChart');

                const customers = this.getCustomers();
                const customerTiers = {
                    bronze: customers.filter(c => c.loyaltyTier === 'bronze').length,
                    silver: customers.filter(c => c.loyaltyTier === 'silver').length,
                    gold: customers.filter(c => c.loyaltyTier === 'gold').length,
                    platinum: customers.filter(c => c.loyaltyTier === 'platinum').length,
                };

                this.charts.customerAnalyticsChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Bronze', 'Silver', 'Gold', 'Platinum'],
                        datasets: [{
                            data: Object.values(customerTiers),
                            backgroundColor: ['#cd7f32', '#c0c0c0', '#ffd700', '#e5e4e2']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            updateStaffPerformanceTable() {
                const tbody = document.getElementById('staffPerformanceTable');
                if (!tbody) return;

                const staffList = this.getStaff();
                const orders = this.getOrders();

                const staffPerformance = staffList.map(member => {
                    const memberOrders = orders.filter(o => o.cashier === member.name);
                    const ordersHandled = memberOrders.length;
                    const salesGenerated = memberOrders.reduce((sum, o) => sum + o.total, 0);
                    const averageOrderValue = ordersHandled > 0 ? salesGenerated / ordersHandled : 0;
                    const performanceScore = (ordersHandled * 0.5) + (salesGenerated * 0.01); // Example scoring

                    return {
                        name: member.name,
                        role: member.role,
                        ordersHandled: ordersHandled,
                        salesGenerated: salesGenerated,
                        averageOrderValue: averageOrderValue,
                        performanceScore: performanceScore
                    };
                }).sort((a, b) => b.performanceScore - a.performanceScore); // Sort by performance

                tbody.innerHTML = staffPerformance.map(sp => `
                <tr>
                    <td>${sp.name}</td>
                    <td>${sp.role}</td>
                    <td>${sp.ordersHandled}</td>
                    <td>${this.formatCurrency(sp.salesGenerated)}</td>
                    <td>${this.formatCurrency(sp.averageOrderValue)}</td>
                    <td>${sp.performanceScore.toFixed(2)}</td>
                </tr>
            `).join('');
            }

            // Settings
            updateSettingsDisplay() {
                const settings = this.getSettings();
                document.getElementById('restaurantName').value = settings.restaurantName || '';
                document.getElementById('restaurantTaxNumber').value = settings.restaurantTaxNumber || '';
                document.getElementById('restaurantAddress').value = settings.restaurantAddress || '';
                document.getElementById('restaurantPhone').value = settings.restaurantPhone || '';
                document.getElementById('restaurantEmail').value = settings.restaurantEmail || '';
                document.getElementById('defaultLanguage').value = settings.defaultLanguage || 'en';
                document.getElementById('vatRate').value = settings.vatRate || 15;
                document.getElementById('lowStockThreshold').value = settings.lowStockThreshold || 10;
                document.getElementById('pointsPerSAR').value = settings.pointsPerSAR || 1;

                this.updateDashboard(); // Update system info in settings tab
            }

            saveSettings() {
                const settings = {
                    restaurantName: document.getElementById('restaurantName').value,
                    restaurantTaxNumber: document.getElementById('restaurantTaxNumber').value,
                    restaurantAddress: document.getElementById('restaurantAddress').value,
                    restaurantPhone: document.getElementById('restaurantPhone').value,
                    restaurantEmail: document.getElementById('restaurantEmail').value,
                    defaultLanguage: document.getElementById('defaultLanguage').value,
                    vatRate: parseFloat(document.getElementById('vatRate').value),
                    lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value),
                    pointsPerSAR: parseFloat(document.getElementById('pointsPerSAR').value)
                };

                if (this.saveData(this.storageKeys.settings, settings)) {
                    this.vatRate = settings.vatRate / 100; // Update manager's VAT rate
                    this.showAlert('Settings saved successfully!', 'success');
                    this.updateDashboard(); // Refresh dashboard with new settings
                } else {
                    this.showAlert('Failed to save settings.', 'error');
                }
            }

            backupData() {
                this.exportDataJSON(); // Re-use export function for backup
                localStorage.setItem('lastBackupTimestamp', new Date().toISOString());
                this.showAlert('Data backup created successfully!', 'success');
                this.updateDashboard(); // Update last backup time in settings
            }

            exportDataExcel() {
                const allData = {
                    menuItems: this.getMenuItems(),
                    orders: this.getOrders(),
                    customers: this.getCustomers(),
                    staff: this.getStaff(),
                    suppliers: this.getSuppliers(),
                    reservations: this.getReservations(),
                    purchaseOrders: this.getPurchaseOrders(),
                    campaigns: this.getCampaigns(),
                };

                const wb = XLSX.utils.book_new();

                for (const sheetName in allData) {
                    if (allData.hasOwnProperty(sheetName)) {
                        const ws = XLSX.utils.json_to_sheet(allData[sheetName]);
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    }
                }

                XLSX.writeFile(wb, `restaurant_data_${new Date().toISOString().split('T')[0]}.xlsx`);
                this.showAlert('Data exported to Excel successfully!', 'success');
            }

            generateDailySalesReport() {
                const orders = this.getOrders();
                const today = new Date().toDateString();
                const dailyOrders = orders.filter(o => new Date(o.createdAt).toDateString() === today);

                let reportContent = `Daily Sales Report - ${today}\n\n`;
                reportContent += `Total Orders: ${dailyOrders.length}\n`;
                reportContent += `Total Revenue: ${this.formatCurrency(dailyOrders.reduce((sum, o) => sum + o.total, 0))}\n\n`;
                reportContent += `Orders Details:\n`;
                dailyOrders.forEach(order => {
                    reportContent += `  Order #${order.orderNumber} - ${this.formatCurrency(order.total)} (${order.orderType})\n`;
                    order.items.forEach(item => {
                        reportContent += `    - ${item.name} x ${item.quantity} @ ${this.formatCurrency(item.price)}\n`;
                    });
                });

                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `daily_sales_report_${today}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showAlert('Daily Sales Report generated!', 'success');
            }

            generateVATReport() {
                const orders = this.getOrders();
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyOrders = orders.filter(o => {
                    const orderDate = new Date(o.createdAt);
                    return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                });

                const totalVAT = monthlyOrders.reduce((sum, o) => sum + o.vatAmount, 0);
                const totalSalesSubjectToVAT = monthlyOrders.reduce((sum, o) => sum + o.subtotal, 0);

                let reportContent = `Monthly VAT Report - ${new Date().toLocaleString('default', { month: 'long', year: 'numeric' })}\n\n`;
                reportContent += `VAT Rate: ${(this.vatRate * 100)}%\n`;
                reportContent += `Total Sales Subject to VAT: ${this.formatCurrency(totalSalesSubjectToVAT)}\n`;
                reportContent += `Total VAT Collected: ${this.formatCurrency(totalVAT)}\n\n`;
                reportContent += `This report is for KSA tax compliance purposes.\n`;

                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `monthly_vat_report_${currentYear}_${currentMonth + 1}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showAlert('Monthly VAT Report generated!', 'success');
            }

            generateProfitReport() {
                const orders = this.getOrders();
                const menuItems = this.getMenuItems();
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyOrders = orders.filter(o => {
                    const orderDate = new Date(o.createdAt);
                    return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                });

                let totalRevenue = 0;
                let totalCostOfGoodsSold = 0;

                monthlyOrders.forEach(order => {
                    totalRevenue += order.total;
                    order.items.forEach(item => {
                        const menuItem = menuItems.find(mi => mi.id === item.id);
                        if (menuItem) {
                            totalCostOfGoodsSold += (menuItem.cost || 0) * item.quantity;
                        }
                    });
                });

                const grossProfit = totalRevenue - totalCostOfGoodsSold;

                let reportContent = `Monthly Profit Analysis - ${new Date().toLocaleString('default', { month: 'long', year: 'numeric' })}\n\n`;
                reportContent += `Total Revenue: ${this.formatCurrency(totalRevenue)}\n`;
                reportContent += `Total Cost of Goods Sold: ${this.formatCurrency(totalCostOfGoodsSold)}\n`;
                reportContent += `Gross Profit: ${this.formatCurrency(grossProfit)}\n\n`;
                reportContent += `Note: This is a simplified profit calculation and does not include other operational expenses.\n`;

                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `monthly_profit_report_${currentYear}_${currentMonth + 1}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showAlert('Monthly Profit Report generated!', 'success');
            }
        }

        // Initialize the system
        let dataManager;
        let currentTab = 'dashboard';

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            dataManager = new EnhancedDataManager();
            const lastActiveTab = localStorage.getItem('lastActiveTab'); // Retrieve saved tab
            showTab(lastActiveTab || 'dashboard'); // Use saved tab or default to dashboard
            updateAllDisplays();
        });

        // Tab Management
        function showTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.section-container').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(tabName).classList.remove('hidden');

            // Add active class to selected tab
            document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`).classList.add('active');

            currentTab = tabName;
            localStorage.setItem('lastActiveTab', tabName); // Save the last active tab

            // Update content based on tab
            switch (tabName) {
                case 'dashboard':
                    dataManager.updateDashboard();
                    break;
                case 'orders':
                    updateOrdersDisplay();
                    break;
                case 'kitchen':
                    dataManager.updateKitchenDisplay();
                    break;
                case 'menu':
                    updateMenuDisplay();
                    break;
                case 'inventory':
                    dataManager.updateInventoryDisplay();
                    break;
                case 'customers':
                    updateCustomersDisplay();
                    break;
                case 'loyalty':
                    dataManager.updateLoyaltyDisplay();
                    break;
                case 'reservations':
                    dataManager.updateReservationsDisplay();
                    break;
                case 'staff':
                    dataManager.updateStaffDisplay();
                    break;
                case 'suppliers':
                    dataManager.updateSuppliersDisplay();
                    break;
                case 'reports':
                    dataManager.updateReportsDisplay();
                    break;
                case 'settings':
                    dataManager.updateSettingsDisplay();
                    break;
            }
        }

        // Order Management Functions
        function showCreateOrderForm() {
            document.getElementById('createOrderForm').classList.remove('hidden');
            document.getElementById('orderFormTitle').textContent = 'Create New Order';
            document.getElementById('saveOrderBtn').textContent = 'Create Order';
            document.getElementById('orderId').value = ''; // Clear hidden order ID
            loadCashierOptions();
            document.getElementById('orderItemsContainer').innerHTML = ''; // Clear previous items
            addOrderItem(); // Add one item by default
            calculateOrderTotal(); // Recalculate total
            clearCreateOrderForm(); // Ensure form is clean for new order
        }

        function showEditOrderForm(orderId) {
            const order = dataManager.getOrders().find(o => o.id === orderId);
            if (!order) {
                dataManager.showAlert('Order not found for editing.', 'error');
                return;
            }

            document.getElementById('createOrderForm').classList.remove('hidden');
            document.getElementById('orderFormTitle').textContent = `Edit Order #${order.orderNumber}`;
            document.getElementById('saveOrderBtn').textContent = 'Update Order';
            document.getElementById('orderId').value = order.id; // Set hidden order ID

            document.getElementById('orderCustomerPhone').value = order.customerPhone || '';
            document.getElementById('orderCashier').value = order.cashier || '';
            document.getElementById('orderTable').value = order.table || '';
            document.getElementById('orderType').value = order.orderType || 'dine-in';
            // Format date for datetime-local input
            if (order.orderDate) {
                const date = new Date(order.orderDate);
                document.getElementById('orderDate').value = date.toISOString().slice(0, 16);
            } else {
                document.getElementById('orderDate').value = '';
            }
            document.getElementById('orderNotes').value = order.notes || '';

            // Populate order items
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            orderItemsContainer.innerHTML = ''; // Clear existing items
            order.items.forEach(item => {
                addOrderItem(item); // Add each existing item
            });
            calculateOrderTotal(); // Recalculate total based on loaded items
            loadCashierOptions(); // Ensure cashiers are loaded
        }


        function hideCreateOrderForm() {
            document.getElementById('createOrderForm').classList.add('hidden');
            clearCreateOrderForm();
        }

        function loadCashierOptions() {
            const cashierSelect = document.getElementById('orderCashier');
            const staff = dataManager.getStaff().filter(s => s.role === 'cashier' && s.active);

            // Store current selected value before clearing
            const currentSelectedCashier = cashierSelect.value;

            cashierSelect.innerHTML = '<option value="">Select Cashier *</option>';
            staff.forEach(cashier => {
                cashierSelect.innerHTML += `<option value="${cashier.name}">${cashier.name}</option>`;
            });

            // Restore selected value if it still exists
            if (currentSelectedCashier && staff.some(s => s.name === currentSelectedCashier)) {
                cashierSelect.value = currentSelectedCashier;
            }
        }

        function addOrderItem(item = {}) {
            const container = document.getElementById('orderItemsContainer');
            const menuItems = dataManager.getMenuItems();

            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2 mb-2';
            itemDiv.innerHTML = `
            <select class="form-input flex-1 order-item-select" onchange="updateOrderItemPrice(this)">
                <option value="">Select Item</option>
                ${menuItems.map(menuItem => `<option value="${menuItem.id}" data-price="${menuItem.price}" ${item.id === menuItem.id ? 'selected' : ''}>${menuItem.name} - ${dataManager.formatCurrency(menuItem.price)}</option>`).join('')}
            </select>
            <input type="number" class="form-input w-20 order-quantity" placeholder="Qty" min="1" value="${item.quantity || 1}" onchange="calculateOrderTotal()">
            <input type="number" class="form-input w-24 order-price" placeholder="Price" readonly value="${item.price || ''}">
            <button type="button" onclick="this.parentElement.remove(); calculateOrderTotal();" class="btn btn-danger btn-sm">
                <i class="fas fa-trash"></i>
            </button>
        `;
            container.appendChild(itemDiv);

            // If an item was passed, ensure its price is correctly set initially
            if (item.id && !item.price) { // If price wasn't explicitly set in item object, get from menu
                const selectedOption = itemDiv.querySelector(`.order-item-select option[value="${item.id}"]`);
                if (selectedOption) {
                    itemDiv.querySelector('.order-price').value = selectedOption.dataset.price;
                }
            }
        }

        function updateOrderItemPrice(select) {
            const priceInput = select.parentElement.querySelector('.order-price');
            const option = select.selectedOptions[0];
            if (option && option.dataset.price) {
                priceInput.value = option.dataset.price;
                calculateOrderTotal();
            } else {
                priceInput.value = '';
                calculateOrderTotal();
            }
        }

        function calculateOrderTotal() {
            let subtotal = 0;
            document.querySelectorAll('#orderItemsContainer > div').forEach(itemDiv => {
                const quantity = parseFloat(itemDiv.querySelector('.order-quantity').value) || 0;
                const price = parseFloat(itemDiv.querySelector('.order-price').value) || 0;
                subtotal += quantity * price;
            });

            const vat = subtotal * dataManager.vatRate;
            const total = subtotal + vat;

            document.getElementById('orderSubtotal').textContent = dataManager.formatCurrency(subtotal);
            document.getElementById('orderVAT').textContent = dataManager.formatCurrency(vat);
            document.getElementById('orderTotal').textContent = dataManager.formatCurrency(total);
        }

        function createOrder() {
            const orderId = document.getElementById('orderId').value; // Check if editing an existing order
            const customerPhone = document.getElementById('orderCustomerPhone').value.trim();
            const cashier = document.getElementById('orderCashier').value;
            const table = document.getElementById('orderTable').value.trim();
            const orderType = document.getElementById('orderType').value;
            const notes = document.getElementById('orderNotes').value.trim();
            const orderDate = document.getElementById('orderDate').value || new Date().toISOString().slice(0, 16); // Default to now if not set

            if (!customerPhone || !cashier) {
                dataManager.showAlert('Please fill in Customer Phone and select Cashier.', 'error');
                return;
            }

            // Collect order items
            const items = [];
            let hasInvalidItem = false;
            document.querySelectorAll('#orderItemsContainer > div').forEach(itemDiv => {
                const select = itemDiv.querySelector('.order-item-select');
                const quantity = parseFloat(itemDiv.querySelector('.order-quantity').value);
                const price = parseFloat(itemDiv.querySelector('.order-price').value);

                if (select.value && quantity > 0 && price >= 0) {
                    const menuItem = dataManager.getMenuItems().find(item => item.id === select.value);
                    if (menuItem) {
                        items.push({
                            id: select.value,
                            name: menuItem.name,
                            quantity: quantity,
                            price: price // Use the price from the input, not necessarily the menu item's current price
                        });
                    }
                } else {
                    hasInvalidItem = true;
                }
            });

            if (items.length === 0) {
                dataManager.showAlert('Please add at least one valid item to the order.', 'error');
                return;
            }
            if (hasInvalidItem) {
                dataManager.showAlert('Some items have invalid quantity or price and were not added.', 'warning');
            }

            const orderData = {
                customerPhone,
                cashier,
                table,
                orderType,
                notes,
                orderDate,
                items,
                status: 'pending' // Default status for new orders or if not explicitly set for updates
            };

            let success = false;
            if (orderId) {
                // Update existing order
                orderData.id = orderId;
                const existingOrder = dataManager.getOrders().find(o => o.id === orderId);
                if (existingOrder) {
                    orderData.orderNumber = existingOrder.orderNumber; // Keep original order number
                    orderData.createdAt = existingOrder.createdAt; // Keep original creation date
                    orderData.status = existingOrder.status; // Keep original status unless changed
                }
                success = dataManager.updateOrder(orderData);
                if (success) {
                    dataManager.showAlert('Order updated successfully!', 'success');
                } else {
                    dataManager.showAlert('Failed to update order. Check stock levels.', 'error');
                }
            } else {
                // Create new order
                success = dataManager.addOrder(orderData);
                if (success) {
                    dataManager.showAlert('Order created successfully!', 'success');
                } else {
                    dataManager.showAlert('Failed to create order. Check stock levels.', 'error');
                }
            }

            if (success) {
                hideCreateOrderForm();
                updateOrdersDisplay(); // Refresh orders list
                dataManager.updateKitchenDisplay(); // Refresh kitchen display
                dataManager.updateDashboard(); // Refresh dashboard stats
                refreshOrders();
            }
            refreshOrde
        }

        // ======= Clear the order form =======
        function clearCreateOrderForm() {
            document.getElementById('orderId').value = '';
            document.getElementById('orderCustomerPhone').value = '';
            document.getElementById('orderCashier').value = '';
            document.getElementById('orderTable').value = '';
            document.getElementById('orderType').value = 'dine-in';
            document.getElementById('orderNotes').value = '';
            document.getElementById('orderDate').value = '';
            document.getElementById('orderItemsContainer').innerHTML = '';
            document.getElementById('orderFormTitle').textContent = 'Create New Order';
            document.getElementById('saveOrderBtn').textContent = 'Create Order';
            calculateOrderTotal();
        }

        // ======= Create or Update Order =======
        function saveOrder() {
            const orders = dataManager.getOrders() || [];

            const orderId = document.getElementById('orderId').value.trim();
            const customerPhone = document.getElementById('orderCustomerPhone').value.trim();
            const cashier = document.getElementById('orderCashier').value.trim();
            const table = document.getElementById('orderTable').value.trim();
            const orderType = document.getElementById('orderType').value || 'dine-in';
            const notes = document.getElementById('orderNotes').value.trim();
            const orderDate = document.getElementById('orderDate').value || new Date().toISOString();
            const items = dataManager.getCurrentOrderItems();
            const totals = calculateOrderTotal();

            if (!items.length) {
                dataManager.showAlert('Cannot create an empty order.', 'error');
                return;
            }

            if (orderId) {
                // Update existing order
                const index = orders.findIndex(o => o.id === orderId);
                if (index !== -1) {
                    orders[index] = {
                        ...orders[index],
                        customerPhone,
                        cashier,
                        table,
                        orderType,
                        notes,
                        items,
                        subtotal: totals.subtotal,
                        vatAmount: totals.vatAmount,
                        total: totals.total,
                        updatedAt: new Date().toISOString(),
                    };
                }
            } else {
                // Create new order
                const newOrder = {
                    id: crypto.randomUUID(),
                    orderNumber: orders.length + 1,
                    customerPhone,
                    cashier,
                    table,
                    orderType,
                    notes,
                    items,
                    subtotal: totals.subtotal,
                    vatAmount: totals.vatAmount,
                    total: totals.total,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                };
                orders.push(newOrder);
            }

            // Save to storage
            dataManager.saveData(dataManager.storageKeys.orders, orders);

            // Update UI
            updateOrdersDisplay();
            dataManager.updateDashboard();
            dataManager.updateKitchenDisplay();

            // Clear form
            clearCreateOrderForm();

            dataManager.showAlert('Order saved successfully!', 'success');
        }

        // ======= Display Orders in Table =======
        function updateOrdersDisplay() {
            const tbody = document.getElementById('ordersTable');
            if (!tbody) return;

            const orders = dataManager.getOrders() || [];
            if (!orders.length) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-gray-500">No orders found.</td></tr>`;
                return;
            }

            tbody.innerHTML = orders
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .map(order => `
            <tr>
                <td class="font-bold text-blue-600">#${order.orderNumber || '-'}</td>
                <td>${order.customerPhone || '-'}</td>
                <td>${order.orderType || 'dine-in'}</td>
                <td>${order.items?.length || 0} items</td>
                <td>${dataManager.formatCurrency(order.subtotal || 0)}</td>
                <td>${dataManager.formatCurrency(order.vatAmount || 0)}</td>
                <td class="font-bold">${dataManager.formatCurrency(order.total || 0)}</td>
                <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                <td>${order.createdAt ? new Date(order.createdAt).toLocaleString() : '-'}</td>
                <td>
                    <div class="flex gap-1">
                        <button onclick="showEditOrderForm('${order.id}')" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="viewOrderReceipt('${order.id}')" class="btn btn-info btn-sm">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        }

        // ======= View Receipt =======
        async function viewOrderReceipt(orderId) {
            const receiptHTML = await dataManager.generateReceipt(orderId);
            if (receiptHTML) {
                document.getElementById('receiptContent').innerHTML = receiptHTML;
                document.getElementById('receiptModal').classList.remove('hidden');
                document.getElementById('receiptModal').classList.add('flex');
            } else {
                dataManager.showAlert('Could not generate receipt for this order.', 'error');
            }
        }

        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.add('hidden');
            document.getElementById('receiptModal').classList.remove('flex');
        }

        function printReceipt() {
            const receiptContent = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
        <html>
            <head>
                <title>Receipt</title>
                <style>
                    body { font-family: monospace; padding: 20px; }
                    .receipt-container { max-width: 300px; margin: 0 auto; }
                    table { width: 100%; border-collapse: collapse; }
                    table th, table td { padding: 5px; text-align: left; }
                    table th { border-bottom: 1px solid #000; }
                    .text-center { text-align: center; }
                    .text-right { text-align: right; }
                    .border-t { border-top: 1px solid #000; }
                    .border-b { border-bottom: 1px solid #000; }
                    .font-bold { font-weight: bold; }
                </style>
            </head>
            <body>${receiptContent}</body>
        </html>
    `);
            printWindow.document.close();
            printWindow.print();
        }

        function emailReceipt() {
            dataManager.showAlert('Email receipt functionality not yet implemented.', 'info');
        }

        // ======= Update Order Status =======
        function updateOrderStatus(orderId, status) {
            const orders = dataManager.getOrders();
            const index = orders.findIndex(o => o.id === orderId);
            if (index !== -1) {
                orders[index].status = status;
                orders[index].updatedAt = new Date().toISOString();
                dataManager.saveData(dataManager.storageKeys.orders, orders);
                dataManager.showAlert(`Order status updated to ${status}`, 'success');
                updateOrdersDisplay();
                dataManager.updateKitchenDisplay();
                dataManager.updateDashboard();
            }
        }

        // ======= Delete Order =======
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                const orders = dataManager.getOrders();
                const orderToDelete = orders.find(o => o.id === orderId);

                if (orderToDelete) {
                    let menuItems = dataManager.getMenuItems();
                    orderToDelete.items.forEach(deletedItem => {
                        const itemIndex = menuItems.findIndex(mi => mi.id === deletedItem.id);
                        if (itemIndex !== -1) {
                            menuItems[itemIndex].stock += deletedItem.quantity;
                        }
                    });
                    dataManager.saveData(dataManager.storageKeys.menuItems, menuItems);
                    dataManager.updateCustomerLoyalty(orderToDelete.customerPhone, 0, orderToDelete.total);
                    const updatedOrders = orders.filter(o => o.id !== orderId);
                    dataManager.saveData(dataManager.storageKeys.orders, updatedOrders);
                    dataManager.showAlert('Order deleted successfully', 'success');
                    updateOrdersDisplay();
                    dataManager.updateDashboard();
                } else {
                    dataManager.showAlert('Order not found for deletion.', 'error');
                }
            }
        }
        // ======= Export Orders to Excel =======
function exportOrdersToExcel() {
    const orders = dataManager.getOrders() || [];

    if (!orders.length) {
        dataManager.showAlert('No orders available to export.', 'error');
        return;
    }

    // Prepare data
    const exportData = orders.map(order => ({
        Order_Number: order.orderNumber || '',
        Customer_Phone: order.customerPhone || '',
        Cashier: order.cashier || '',
        Table: order.table || '',
        Order_Type: order.orderType || '',
        Notes: order.notes || '',
        Items_Count: order.items?.length || 0,
        Subtotal: order.subtotal || 0,
        VAT: order.vatAmount || 0,
        Total: order.total || 0,
        Status: order.status || '',
        Created_At: order.createdAt || '',
        Updated_At: order.updatedAt || ''
    }));

    // Use SheetJS for Excel export
    const worksheet = XLSX.utils.json_to_sheet(exportData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Orders');
    XLSX.writeFile(workbook, `orders_${new Date().toISOString().slice(0,10)}.xlsx`);

    dataManager.showAlert('Orders exported to Excel successfully!', 'success');
}

// ======= Export Orders to JSON =======
function exportOrdersToJSON() {
    const orders = dataManager.getOrders() || [];

    if (!orders.length) {
        dataManager.showAlert('No orders available to export.', 'error');
        return;
    }

    const jsonContent = JSON.stringify(orders, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `orders_${new Date().toISOString().slice(0,10)}.json`;
    link.click();

    dataManager.showAlert('Orders exported to JSON successfully!', 'success');
}
        // ======= Delete All Orders =======
        function deleteAllOrders() {
            if (!confirm('Are you sure you want to delete ALL orders? This action cannot be undone.')) {
                return;
            }

            // Clear orders from storage
            dataManager.saveData(dataManager.storageKeys.orders, []);

            // Update UI
            updateOrdersDisplay();
            dataManager.updateDashboard();
            dataManager.updateKitchenDisplay();

            dataManager.showAlert('All orders have been deleted successfully!', 'success');
        }


        function filterKitchenOrders() {
            dataManager.updateKitchenDisplay();
        }

        // Menu Management Functions
        function showAddMenuItemForm(item = {}) {
            document.getElementById('addMenuItemForm').classList.remove('hidden');
            document.getElementById('menuItemName').value = item.name || '';
            document.getElementById('menuItemPrice').value = item.price || '';
            document.getElementById('menuItemCost').value = item.cost || '';
            document.getElementById('menuItemCategory').value = item.category || '';
            document.getElementById('menuItemStock').value = item.stock || '';
            document.getElementById('menuItemUnit').value = item.unit || 'pcs';
            document.getElementById('menuItemDescription').value = item.description || '';
            document.getElementById('menuItemExpiry').value = item.expiryDate || '';

            const saveButton = document.querySelector('#addMenuItemForm .btn-success');
            if (item.id) {
                saveButton.textContent = 'Update Item';
                saveButton.onclick = () => editMenuItemSave(item.id);
            } else {
                saveButton.textContent = 'Add Item';
                saveButton.onclick = addMenuItem;
            }
        }

        function hideAddMenuItemForm() {
            document.getElementById('addMenuItemForm').classList.add('hidden');
            clearMenuItemForm();
        }

        function addMenuItem() {
            const name = document.getElementById('menuItemName').value.trim();
            const price = parseFloat(document.getElementById('menuItemPrice').value);
            const cost = parseFloat(document.getElementById('menuItemCost').value) || 0;
            const category = document.getElementById('menuItemCategory').value;
            const stock = parseInt(document.getElementById('menuItemStock').value) || 0;
            const unit = document.getElementById('menuItemUnit').value;
            const description = document.getElementById('menuItemDescription').value.trim();
            const expiryDate = document.getElementById('menuItemExpiry').value;

            if (!name || isNaN(price) || price <= 0 || !category) {
                dataManager.showAlert('Please fill in required fields (Name, Price, Category) correctly.', 'error');
                return;
            }

            const menuItem = {
                id: Date.now().toString(),
                name,
                price,
                cost,
                category,
                description,
                stock,
                unit,
                expiryDate,
                createdAt: new Date().toISOString()
            };

            const menuItems = dataManager.getMenuItems();
            menuItems.push(menuItem);

            if (dataManager.saveData(dataManager.storageKeys.menuItems, menuItems)) {
                dataManager.showAlert('Menu item added successfully!', 'success');
                hideAddMenuItemForm();
                updateMenuDisplay();
                dataManager.updateDashboard(); // Update low stock count
            }
        }

        function editMenuItem(itemId) {
            const menuItems = dataManager.getMenuItems();
            const itemToEdit = menuItems.find(item => item.id === itemId);
            if (itemToEdit) {
                showAddMenuItemForm(itemToEdit);
            } else {
                dataManager.showAlert('Menu item not found.', 'error');
            }
        }

        function editMenuItemSave(itemId) {
            const menuItems = dataManager.getMenuItems();
            const itemIndex = menuItems.findIndex(item => item.id === itemId);

            if (itemIndex !== -1) {
                const name = document.getElementById('menuItemName').value.trim();
                const price = parseFloat(document.getElementById('menuItemPrice').value);
                const cost = parseFloat(document.getElementById('menuItemCost').value) || 0;
                const category = document.getElementById('menuItemCategory').value;
                const stock = parseInt(document.getElementById('menuItemStock').value) || 0;
                const unit = document.getElementById('menuItemUnit').value;
                const description = document.getElementById('menuItemDescription').value.trim();
                const expiryDate = document.getElementById('menuItemExpiry').value;

                if (!name || isNaN(price) || price <= 0 || !category) {
                    dataManager.showAlert('Please fill in required fields (Name, Price, Category) correctly.', 'error');
                    return;
                }

                menuItems[itemIndex] = {
                    ...menuItems[itemIndex], // Keep existing properties
                    name,
                    price,
                    cost,
                    category,
                    description,
                    stock,
                    unit,
                    expiryDate,
                    updatedAt: new Date().toISOString()
                };

                if (dataManager.saveData(dataManager.storageKeys.menuItems, menuItems)) {
                    dataManager.showAlert('Menu item updated successfully!', 'success');
                    hideAddMenuItemForm();
                    updateMenuDisplay();
                    dataManager.updateDashboard();
                }
            } else {
                dataManager.showAlert('Menu item not found for update.', 'error');
            }
        }

        function clearMenuItemForm() {
            document.getElementById('menuItemName').value = '';
            document.getElementById('menuItemPrice').value = '';
            document.getElementById('menuItemCost').value = '';
            document.getElementById('menuItemCategory').value = '';
            document.getElementById('menuItemStock').value = '';
            document.getElementById('menuItemUnit').value = 'pcs';
            document.getElementById('menuItemDescription').value = '';
            document.getElementById('menuItemExpiry').value = '';
        }

        function updateMenuDisplay() {
            const container = document.getElementById('menuItemsList');
            if (!container) return;

            const menuItems = dataManager.getMenuItems();
            const lowStockThreshold = dataManager.getSettings().lowStockThreshold || 10;

            container.innerHTML = menuItems.map(item => `
            <div class="card mb-3">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${item.name}</h4>
                        <p class="text-gray-600 text-sm">${item.description || 'No description'}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <span class="font-bold text-green-600">${dataManager.formatCurrency(item.price)}</span>
                            <span class="text-sm text-gray-500">Cost: ${dataManager.formatCurrency(item.cost || 0)}</span>
                            <span class="text-sm ${item.stock <= lowStockThreshold ? 'low-stock' : ''}">Stock: ${item.stock} ${item.unit || 'pcs'}</span>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${item.category}</span>
                            ${item.expiryDate ? `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Expires: ${new Date(item.expiryDate).toLocaleDateString()}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editMenuItem('${item.id}')" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMenuItem('${item.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        }

        function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this menu item? This action cannot be undone.')) {
                const menuItems = dataManager.getMenuItems().filter(item => item.id !== itemId);
                dataManager.saveData(dataManager.storageKeys.menuItems, menuItems);
                dataManager.showAlert('Menu item deleted successfully', 'success');
                updateMenuDisplay();
                dataManager.updateDashboard();
            }
        }

        // Inventory Management Functions
        function promptUpdateStock(itemId, itemName) {
            const quantity = prompt(`Enter quantity to add to ${itemName} stock:`);
            if (quantity !== null) {
                const numQuantity = parseInt(quantity);
                if (!isNaN(numQuantity) && numQuantity !== 0) {
                    dataManager.updateStock(itemId, numQuantity);
                } else {
                    dataManager.showAlert('Invalid quantity entered.', 'error');
                }
            }
        }

        function showCreatePurchaseOrderForm() {
            document.getElementById('createPurchaseOrderForm').classList.remove('hidden');
            loadSupplierOptions();
            document.getElementById('poItemsContainer').innerHTML = '<h5 class="font-medium mb-2">Items:</h5><button type="button" onclick="addPOItem()" class="btn btn-info btn-sm"><i class="fas fa-plus"></i>Add Item</button>';
            addPOItem(); // Add one item by default
        }

        function hideCreatePurchaseOrderForm() {
            document.getElementById('createPurchaseOrderForm').classList.add('hidden');
            clearPurchaseOrderForm();
        }

        function loadSupplierOptions() {
            const supplierSelect = document.getElementById('poSupplier');
            const suppliers = dataManager.getSuppliers();

            supplierSelect.innerHTML = '<option value="">Select Supplier *</option>';
            suppliers.forEach(supplier => {
                supplierSelect.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
        }

        function addPOItem() {
            const container = document.getElementById('poItemsContainer');
            const menuItems = dataManager.getMenuItems(); // Can also be raw ingredients

            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2 mb-2';
            itemDiv.innerHTML = `
            <select class="form-input flex-1 po-item-select">
                <option value="">Select Item</option>
                ${menuItems.map(item => `<option value="${item.id}">${item.name}</option>`).join('')}
            </select>
            <input type="number" class="form-input w-20 po-quantity" placeholder="Qty" min="1" value="1">
            <input type="number" class="form-input w-24 po-price" placeholder="Unit Price" step="0.01">
            <button type="button" onclick="this.parentElement.remove();" class="btn btn-danger btn-sm">
                <i class="fas fa-trash"></i>
            </button>
        `;
            container.appendChild(itemDiv);
        }

        function createPurchaseOrder() {
            const supplierId = document.getElementById('poSupplier').value;
            const poDate = document.getElementById('poDate').value || new Date().toISOString().split('T')[0];
            const poNotes = document.getElementById('poNotes').value.trim();

            if (!supplierId) {
                dataManager.showAlert('Please select a supplier.', 'error');
                return;
            }

            const items = [];
            let hasInvalidItem = false;
            document.querySelectorAll('#poItemsContainer > div.flex').forEach(itemDiv => {
                const select = itemDiv.querySelector('.po-item-select');
                const quantity = parseFloat(itemDiv.querySelector('.po-quantity').value);
                const price = parseFloat(itemDiv.querySelector('.po-price').value);

                if (select.value && quantity > 0 && price >= 0) {
                    const selectedItem = dataManager.getMenuItems().find(item => item.id === select.value); // Assuming PO items are menu items for simplicity
                    if (selectedItem) {
                        items.push({
                            id: select.value,
                            name: selectedItem.name,
                            quantity: quantity,
                            price: price
                        });
                    }
                } else {
                    hasInvalidItem = true;
                }
            });

            if (items.length === 0) {
                dataManager.showAlert('Please add at least one valid item to the purchase order.', 'error');
                return;
            }
            if (hasInvalidItem) {
                dataManager.showAlert('Some PO items have invalid quantity or price and were not added.', 'warning');
            }

            const purchaseOrder = {
                supplierId,
                poDate,
                notes: poNotes,
                items,
                status: 'pending'
            };

            if (dataManager.addPurchaseOrder(purchaseOrder)) {
                dataManager.showAlert('Purchase order created successfully!', 'success');
                hideCreatePurchaseOrderForm();
                dataManager.updatePurchaseOrdersDisplay();
            }
        }

        function clearPurchaseOrderForm() {
            document.getElementById('poSupplier').value = '';
            document.getElementById('poDate').value = '';
            document.getElementById('poNotes').value = '';
            document.getElementById('poItemsContainer').innerHTML = '<h5 class="font-medium mb-2">Items:</h5><button type="button" onclick="addPOItem()" class="btn btn-info btn-sm"><i class="fas fa-plus"></i>Add Item</button>';
        }

        function updatePurchaseOrderStatus(poId, status) {
            const purchaseOrders = dataManager.getPurchaseOrders();
            const poIndex = purchaseOrders.findIndex(po => po.id === poId);

            if (poIndex !== -1) {
                purchaseOrders[poIndex].status = status;
                purchaseOrders[poIndex].updatedAt = new Date().toISOString();

                // If status is 'received', update inventory stock
                if (status === 'received') {
                    const menuItems = dataManager.getMenuItems();
                    purchaseOrders[poIndex].items.forEach(poItem => {
                        const menuItemIndex = menuItems.findIndex(mi => mi.id === poItem.id);
                        if (menuItemIndex !== -1) {
                            menuItems[menuItemIndex].stock += poItem.quantity;
                        }
                    });
                    dataManager.saveData(dataManager.storageKeys.menuItems, menuItems);
                    dataManager.showAlert('Inventory updated from received purchase order.', 'info');
                }

                dataManager.saveData(dataManager.storageKeys.purchaseOrders, purchaseOrders);
                dataManager.showAlert(`Purchase order status updated to ${status}`, 'success');
                dataManager.updatePurchaseOrdersDisplay();
                dataManager.updateInventoryDisplay(); // Refresh inventory view
                dataManager.updateDashboard(); // Update low stock count
            }
        }

        function deletePurchaseOrder(poId) {
            if (confirm('Are you sure you want to delete this purchase order?')) {
                const purchaseOrders = dataManager.getPurchaseOrders().filter(po => po.id !== poId);
                dataManager.saveData(dataManager.storageKeys.purchaseOrders, purchaseOrders);
                dataManager.showAlert('Purchase order deleted successfully', 'success');
                dataManager.updatePurchaseOrdersDisplay();
            }
        }

        // Customer Management Functions
        function showAddCustomerForm(customer = {}) {
            document.getElementById('addCustomerForm').classList.remove('hidden');
            document.getElementById('customerName').value = customer.name || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerBirthdate').value = customer.birthdate || '';
            document.getElementById('customerAddress').value = customer.address || '';

            const saveButton = document.querySelector('#addCustomerForm .btn-success');
            if (customer.id) {
                saveButton.textContent = 'Update Customer';
                saveButton.onclick = () => editCustomerSave(customer.id);
            } else {
                saveButton.textContent = 'Add Customer';
                saveButton.onclick = addCustomer;
            }
        }

        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').classList.add('hidden');
            clearCustomerForm();
        }

        function addCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            const birthdate = document.getElementById('customerBirthdate').value;

            if (!name || !phone) {
                dataManager.showAlert('Please fill in Customer Name and Phone Number.', 'error');
                return;
            }

            const customer = {
                id: Date.now().toString(),
                name,
                phone,
                email,
                address,
                birthdate,
                totalOrders: 0,
                totalSpent: 0,
                loyaltyPoints: 0,
                loyaltyTier: 'bronze',
                createdAt: new Date().toISOString()
            };

            const customers = dataManager.getCustomers();
            customers.push(customer);

            if (dataManager.saveData(dataManager.storageKeys.customers, customers)) {
                dataManager.showAlert('Customer added successfully!', 'success');
                hideAddCustomerForm();
                updateCustomersDisplay();
                dataManager.updateDashboard(); // Update total customers
            }
        }

        function editCustomer(customerId) {
            const customers = dataManager.getCustomers();
            const customerToEdit = customers.find(c => c.id === customerId);
            if (customerToEdit) {
                showAddCustomerForm(customerToEdit);
            } else {
                dataManager.showAlert('Customer not found.', 'error');
            }
        }

        function editCustomerSave(customerId) {
            const customers = dataManager.getCustomers();
            const customerIndex = customers.findIndex(c => c.id === customerId);

            if (customerIndex !== -1) {
                const name = document.getElementById('customerName').value.trim();
                const phone = document.getElementById('customerPhone').value.trim();
                const email = document.getElementById('customerEmail').value.trim();
                const address = document.getElementById('customerAddress').value.trim();
                const birthdate = document.getElementById('customerBirthdate').value;

                if (!name || !phone) {
                    dataManager.showAlert('Please fill in Customer Name and Phone Number.', 'error');
                    return;
                }

                customers[customerIndex] = {
                    ...customers[customerIndex],
                    name,
                    phone,
                    email,
                    address,
                    birthdate,
                    updatedAt: new Date().toISOString()
                };

                if (dataManager.saveData(dataManager.storageKeys.customers, customers)) {
                    dataManager.showAlert('Customer updated successfully!', 'success');
                    hideAddCustomerForm();
                    updateCustomersDisplay();
                    dataManager.updateDashboard();
                }
            } else {
                dataManager.showAlert('Customer not found for update.', 'error');
            }
        }

        function clearCustomerForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerBirthdate').value = '';
        }

        function updateCustomersDisplay() {
            const tbody = document.getElementById('customersTable');
            if (!tbody) return;

            const customers = dataManager.getCustomers().sort((a, b) => a.name.localeCompare(b.name));

            tbody.innerHTML = customers.map(customer => `
            <tr>
                <td>${customer.name}</td>
                <td>${customer.phone}</td>
                <td>${customer.email || 'N/A'}</td>
                <td><span class="loyalty-tier-${customer.loyaltyTier || 'bronze'} px-2 py-1 rounded text-xs">${(customer.loyaltyTier || 'bronze').toUpperCase()}</span></td>
                <td>${customer.loyaltyPoints || 0}</td>
                <td>${customer.totalOrders || 0}</td>
                <td>${dataManager.formatCurrency(customer.totalSpent || 0)}</td>
                <td>
                    <div class="flex gap-1">
                        <button onclick="editCustomer('${customer.id}')" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        }

        function deleteCustomer(customerId) {
            if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                const customers = dataManager.getCustomers().filter(c => c.id !== customerId);
                dataManager.saveData(dataManager.storageKeys.customers, customers);
                dataManager.showAlert('Customer deleted successfully', 'success');
                updateCustomersDisplay();
                dataManager.updateDashboard();
            }
        }

        // Loyalty Management Functions
        function showCreateCampaignForm(campaign = {}) {
            document.getElementById('createCampaignForm').classList.remove('hidden');
            document.getElementById('campaignName').value = campaign.name || '';
            document.getElementById('campaignDescription').value = campaign.description || '';
            document.getElementById('campaignStartDate').value = campaign.startDate || '';
            document.getElementById('campaignEndDate').value = campaign.endDate || '';
            document.getElementById('campaignDiscount').value = campaign.discount || '';

            const saveButton = document.querySelector('#createCampaignForm .btn-success');
            if (campaign.id) {
                saveButton.textContent = 'Update Campaign';
                saveButton.onclick = () => editCampaignSave(campaign.id);
            } else {
                saveButton.textContent = 'Create Campaign';
                saveButton.onclick = createCampaign;
            }
        }

        function hideCreateCampaignForm() {
            document.getElementById('createCampaignForm').classList.add('hidden');
            clearCampaignForm();
        }

        function createCampaign() {
            const name = document.getElementById('campaignName').value.trim();
            const description = document.getElementById('campaignDescription').value.trim();
            const startDate = document.getElementById('campaignStartDate').value;
            const endDate = document.getElementById('campaignEndDate').value;
            const discount = parseFloat(document.getElementById('campaignDiscount').value) || 0;

            if (!name || !startDate || !endDate) {
                dataManager.showAlert('Please fill in Campaign Name, Start Date, and End Date.', 'error');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                dataManager.showAlert('Start Date cannot be after End Date.', 'error');
                return;
            }

            const campaign = {
                name,
                description,
                startDate,
                endDate,
                discount
            };

            if (dataManager.addCampaign(campaign)) {
                dataManager.showAlert('Campaign created successfully!', 'success');
                hideCreateCampaignForm();
                dataManager.updateLoyaltyDisplay();
            }
        }
        function refreshOrders() {
            const orders = dataManager.getOrders(); // get all orders
            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = ''; // clear table first

            orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${order.orderNumber}</td>
            <td>${order.customerPhone}</td>
            <td>${order.type}</td>
            <td>${order.items.map(i => i.name + ' x' + i.quantity).join(', ')}</td>
            <td>ر.س ${order.subtotal.toFixed(2)}</td>
            <td>ر.س ${order.vatAmount.toFixed(2)}</td>
            <td>ر.س ${order.total.toFixed(2)}</td>
            <td>${order.status}</td>
            <td>${new Date(order.createdAt).toLocaleString()}</td>
            <td>
                <button onclick="editOrder('${order.id}')" class="btn btn-warning btn-sm">Edit</button>
                <button onclick="deleteOrder('${order.id}')" class="btn btn-danger btn-sm">Delete</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }

        function editCampaignSave(campaignId) {
            const campaigns = dataManager.getCampaigns();
            const campaignIndex = campaigns.findIndex(c => c.id === campaignId);

            if (campaignIndex !== -1) {
                const name = document.getElementById('campaignName').value.trim();
                const description = document.getElementById('campaignDescription').value.trim();
                const startDate = document.getElementById('campaignStartDate').value;
                const endDate = document.getElementById('campaignEndDate').value;
                const discount = parseFloat(document.getElementById('campaignDiscount').value) || 0;

                if (!name || !startDate || !endDate) {
                    dataManager.showAlert('Please fill in Campaign Name, Start Date, and End Date.', 'error');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    dataManager.showAlert('Start Date cannot be after End Date.', 'error');
                    return;
                }

                campaigns[campaignIndex] = {
                    ...campaigns[campaignIndex],
                    name,
                    description,
                    startDate,
                    endDate,
                    discount,
                    updatedAt: new Date().toISOString()
                };

                if (dataManager.saveData(dataManager.storageKeys.campaigns, campaigns)) {
                    dataManager.showAlert('Campaign updated successfully!', 'success');
                    hideCreateCampaignForm();
                    dataManager.updateLoyaltyDisplay();
                }
            } else {
                dataManager.showAlert('Campaign not found for update.', 'error');
            }
        }

        function clearCampaignForm() {
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignDescription').value = '';
            document.getElementById('campaignStartDate').value = '';
            document.getElementById('campaignEndDate').value = '';
            document.getElementById('campaignDiscount').value = '';
        }

        function deleteCampaign(campaignId) {
            if (confirm('Are you sure you want to delete this campaign?')) {
                const campaigns = dataManager.getCampaigns().filter(c => c.id !== campaignId);
                dataManager.saveData(dataManager.storageKeys.campaigns, campaigns);
                dataManager.showAlert('Campaign deleted successfully', 'success');
                dataManager.updateLoyaltyDisplay();
            }
        }

        // Reservations Functions
        function showCreateReservationForm(reservation = {}) {
            document.getElementById('createReservationForm').classList.remove('hidden');
            document.getElementById('reservationCustomerName').value = reservation.customerName || '';
            document.getElementById('reservationCustomerPhone').value = reservation.customerPhone || '';
            document.getElementById('reservationDateTime').value = reservation.reservationDateTime ? new Date(reservation.reservationDateTime).toISOString().slice(0, 16) : '';
            document.getElementById('reservationPartySize').value = reservation.partySize || '';
            document.getElementById('reservationTable').value = reservation.table || '';
            document.getElementById('reservationNotes').value = reservation.notes || '';

            const saveButton = document.querySelector('#createReservationForm .btn-success');
            if (reservation.id) {
                saveButton.textContent = 'Update Reservation';
                saveButton.onclick = () => editReservationSave(reservation.id);
            } else {
                saveButton.textContent = 'Create Reservation';
                saveButton.onclick = createReservation;
            }
        }

        function hideCreateReservationForm() {
            document.getElementById('createReservationForm').classList.add('hidden');
            clearReservationForm();
        }

        function createReservation() {
            const customerName = document.getElementById('reservationCustomerName').value.trim();
            const customerPhone = document.getElementById('reservationCustomerPhone').value.trim();
            const reservationDateTime = document.getElementById('reservationDateTime').value;
            const partySize = parseInt(document.getElementById('reservationPartySize').value);
            const table = document.getElementById('reservationTable').value;
            const notes = document.getElementById('reservationNotes').value.trim();

            if (!customerName || !customerPhone || !reservationDateTime || isNaN(partySize) || partySize <= 0) {
                dataManager.showAlert('Please fill in all required reservation fields correctly.', 'error');
                return;
            }
            if (new Date(reservationDateTime) < new Date()) {
                dataManager.showAlert('Reservation date and time cannot be in the past.', 'error');
                return;
            }

            const reservation = {
                customerName,
                customerPhone,
                reservationDateTime,
                partySize,
                table,
                notes
            };

            if (dataManager.addReservation(reservation)) {
                dataManager.showAlert('Reservation created successfully!', 'success');
                hideCreateReservationForm();
                dataManager.updateReservationsDisplay();
            }
        }

        function editReservationSave(reservationId) {
            const reservations = dataManager.getReservations();
            const reservationIndex = reservations.findIndex(r => r.id === reservationId);

            if (reservationIndex !== -1) {
                const customerName = document.getElementById('reservationCustomerName').value.trim();
                const customerPhone = document.getElementById('reservationCustomerPhone').value.trim();
                const reservationDateTime = document.getElementById('reservationDateTime').value;
                const partySize = parseInt(document.getElementById('reservationPartySize').value);
                const table = document.getElementById('reservationTable').value;
                const notes = document.getElementById('reservationNotes').value.trim();

                if (!customerName || !customerPhone || !reservationDateTime || isNaN(partySize) || partySize <= 0) {
                    dataManager.showAlert('Please fill in all required reservation fields correctly.', 'error');
                    return;
                }
                if (new Date(reservationDateTime) < new Date()) {
                    dataManager.showAlert('Reservation date and time cannot be in the past.', 'error');
                    return;
                }

                reservations[reservationIndex] = {
                    ...reservations[reservationIndex],
                    customerName,
                    customerPhone,
                    reservationDateTime,
                    partySize,
                    table,
                    notes,
                    updatedAt: new Date().toISOString()
                };

                if (dataManager.saveData(dataManager.storageKeys.reservations, reservations)) {
                    dataManager.showAlert('Reservation updated successfully!', 'success');
                    hideCreateReservationForm();
                    dataManager.updateReservationsDisplay();
                }
            } else {
                dataManager.showAlert('Reservation not found for update.', 'error');
            }
        }

        function clearReservationForm() {
            document.getElementById('reservationCustomerName').value = '';
            document.getElementById('reservationCustomerPhone').value = '';
            document.getElementById('reservationDateTime').value = '';
            document.getElementById('reservationPartySize').value = '';
            document.getElementById('reservationTable').value = '';
            document.getElementById('reservationNotes').value = '';
        }

        function updateReservationStatus(reservationId, status) {
            const reservations = dataManager.getReservations();
            const reservationIndex = reservations.findIndex(r => r.id === reservationId);

            if (reservationIndex !== -1) {
                reservations[reservationIndex].status = status;
                reservations[reservationIndex].updatedAt = new Date().toISOString();
                dataManager.saveData(dataManager.storageKeys.reservations, reservations);
                dataManager.showAlert(`Reservation status updated to ${status}`, 'success');
                dataManager.updateReservationsDisplay();
            }
        }

        function deleteReservation(reservationId) {
            if (confirm('Are you sure you want to delete this reservation?')) {
                const reservations = dataManager.getReservations().filter(r => r.id !== reservationId);
                dataManager.saveData(dataManager.storageKeys.reservations, reservations);
                dataManager.showAlert('Reservation deleted successfully', 'success');
                dataManager.updateReservationsDisplay();
            }
        }

        // Staff Management Functions
        function showAddStaffForm(staffMember = {}) {
            document.getElementById('addStaffForm').classList.remove('hidden');
            document.getElementById('staffName').value = staffMember.name || '';
            document.getElementById('staffEmail').value = staffMember.email || '';
            document.getElementById('staffPhone').value = staffMember.phone || '';
            document.getElementById('staffRole').value = staffMember.role || '';
            document.getElementById('staffShift').value = staffMember.shift || '';
            document.getElementById('staffSalary').value = staffMember.salary || '';
            document.getElementById('staffHireDate').value = staffMember.hireDate ? new Date(staffMember.hireDate).toISOString().split('T')[0] : '';
            document.getElementById('staffEmployeeId').value = staffMember.employeeId || '';
            document.getElementById('staffNotes').value = staffMember.notes || '';

            const saveButton = document.querySelector('#addStaffForm .btn-success');
            if (staffMember.id) {
                saveButton.textContent = 'Update Staff';
                saveButton.onclick = () => editStaffSave(staffMember.id);
            } else {
                saveButton.textContent = 'Add Staff';
                saveButton.onclick = addStaff;
            }
        }

        function hideAddStaffForm() {
            document.getElementById('addStaffForm').classList.add('hidden');
            clearStaffForm();
        }

        function addStaff() {
            const name = document.getElementById('staffName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const phone = document.getElementById('staffPhone').value.trim();
            const role = document.getElementById('staffRole').value;
            const shift = document.getElementById('staffShift').value;
            const salary = parseFloat(document.getElementById('staffSalary').value) || 0;
            const hireDate = document.getElementById('staffHireDate').value;
            const employeeId = document.getElementById('staffEmployeeId').value.trim();
            const notes = document.getElementById('staffNotes').value.trim();

            if (!name || !phone || !role) {
                dataManager.showAlert('Please fill in Staff Name, Phone, and Role.', 'error');
                return;
            }

            const staffMember = {
                name,
                email,
                phone,
                role,
                shift,
                salary,
                hireDate,
                employeeId,
                notes
            };

            if (dataManager.addStaffMember(staffMember)) {
                dataManager.showAlert('Staff member added successfully!', 'success');
                hideAddStaffForm();
                dataManager.updateStaffDisplay();
            }
        }

        function editStaff(staffId) {
            const staffList = dataManager.getStaff();
            const staffToEdit = staffList.find(s => s.id === staffId);
            if (staffToEdit) {
                showAddStaffForm(staffToEdit);
            } else {
                dataManager.showAlert('Staff member not found.', 'error');
            }
        }

        function editStaffSave(staffId) {
            const staffList = dataManager.getStaff();
            const staffIndex = staffList.findIndex(s => s.id === staffId);

            if (staffIndex !== -1) {
                const name = document.getElementById('staffName').value.trim();
                const email = document.getElementById('staffEmail').value.trim();
                const phone = document.getElementById('staffPhone').value.trim();
                const role = document.getElementById('staffRole').value;
                const shift = document.getElementById('staffShift').value;
                const salary = parseFloat(document.getElementById('staffSalary').value) || 0;
                const hireDate = document.getElementById('staffHireDate').value;
                const employeeId = document.getElementById('staffEmployeeId').value.trim();
                const notes = document.getElementById('staffNotes').value.trim();

                if (!name || !phone || !role) {
                    dataManager.showAlert('Please fill in Staff Name, Phone, and Role.', 'error');
                    return;
                }

                staffList[staffIndex] = {
                    ...staffList[staffIndex],
                    name,
                    email,
                    phone,
                    role,
                    shift,
                    salary,
                    hireDate,
                    employeeId,
                    notes,
                    updatedAt: new Date().toISOString()
                };

                if (dataManager.saveData(dataManager.storageKeys.staff, staffList)) {
                    dataManager.showAlert('Staff member updated successfully!', 'success');
                    hideAddStaffForm();
                    dataManager.updateStaffDisplay();
                }
            } else {
                dataManager.showAlert('Staff member not found for update.', 'error');
            }
        }

        function clearStaffForm() {
            document.getElementById('staffName').value = '';
            document.getElementById('staffEmail').value = '';
            document.getElementById('staffPhone').value = '';
            document.getElementById('staffRole').value = '';
            document.getElementById('staffShift').value = '';
            document.getElementById('staffSalary').value = '';
            document.getElementById('staffHireDate').value = '';
            document.getElementById('staffEmployeeId').value = '';
            document.getElementById('staffNotes').value = '';
        }

        function toggleStaffStatus(staffId) {
            const staffList = dataManager.getStaff();
            const staffIndex = staffList.findIndex(s => s.id === staffId);

            if (staffIndex !== -1) {
                staffList[staffIndex].active = !staffList[staffIndex].active;
                staffList[staffIndex].updatedAt = new Date().toISOString();
                dataManager.saveData(dataManager.storageKeys.staff, staffList);
                dataManager.showAlert(`Staff member status changed to ${staffList[staffIndex].active ? 'Active' : 'Inactive'}`, 'success');
                dataManager.updateStaffDisplay();
            }
        }

        function deleteStaffMember(staffId) {
            if (confirm('Are you sure you want to delete this staff member?')) {
                const staffList = dataManager.getStaff().filter(s => s.id !== staffId);
                dataManager.saveData(dataManager.storageKeys.staff, staffList);
                dataManager.showAlert('Staff member deleted successfully', 'success');
                dataManager.updateStaffDisplay();
            }
        }
        function updateStaffMember(updatedStaff) {
            const staffList = dataManager.getStaff();
            const index = staffList.findIndex(s => s.id === updatedStaff.id);

            if (index !== -1) {
                // تحديث البيانات
                staffList[index] = { ...staffList[index], ...updatedStaff };
                dataManager.saveData(dataManager.storageKeys.staff, staffList);
                dataManager.showAlert('Staff member updated successfully', 'success');
                dataManager.updateStaffDisplay();
            } else {
                dataManager.showAlert('Staff member not found', 'error');
            }
        }

        // Supplier Management Functions
        function showAddSupplierForm(supplier = {}) {
            document.getElementById('addSupplierForm').classList.remove('hidden');
            document.getElementById('supplierName').value = supplier.name || '';
            document.getElementById('supplierContact').value = supplier.contact || '';
            document.getElementById('supplierPhone').value = supplier.phone || '';
            document.getElementById('supplierEmail').value = supplier.email || '';
            document.getElementById('supplierTaxNumber').value = supplier.taxNumber || '';
            document.getElementById('supplierCategory').value = supplier.category || '';
            document.getElementById('supplierAddress').value = supplier.address || '';
            document.getElementById('supplierNotes').value = supplier.notes || '';

            const saveButton = document.querySelector('#addSupplierForm .btn-success');
            if (supplier.id) {
                saveButton.textContent = 'Update Supplier';
                saveButton.onclick = () => editSupplierSave(supplier.id);
            } else {
                saveButton.textContent = 'Add Supplier';
                saveButton.onclick = addSupplier;
            }
        }

        function hideAddSupplierForm() {
            document.getElementById('addSupplierForm').classList.add('hidden');
            clearSupplierForm();
        }

        function addSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const contact = document.getElementById('supplierContact').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
            const category = document.getElementById('supplierCategory').value;
            const address = document.getElementById('supplierAddress').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();

            if (!name || !phone) {
                dataManager.showAlert('Please fill in Company Name and Phone.', 'error');
                return;
            }

            const supplier = {
                name,
                contact,
                phone,
                email,
                taxNumber,
                category,
                address,
                notes
            };

            if (dataManager.addSupplier(supplier)) {
                dataManager.showAlert('Supplier added successfully!', 'success');
                hideAddSupplierForm();
                dataManager.updateSuppliersDisplay();
            }
        }

        function editSupplier(supplierId) {
            const suppliers = dataManager.getSuppliers();
            const supplierToEdit = suppliers.find(s => s.id === supplierId);
            if (supplierToEdit) {
                showAddSupplierForm(supplierToEdit);
            } else {
                dataManager.showAlert('Supplier not found.', 'error');
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            dataManager = new EnhancedDataManager();
            const lastActiveTab = localStorage.getItem('lastActiveTab'); // Retrieve saved tab
            showTab(lastActiveTab || 'dashboard'); // Use saved tab or default to dashboard
            updateAllDisplays();
        });


        function editSupplierSave(supplierId) {
            const suppliers = dataManager.getSuppliers();
            const supplierIndex = suppliers.findIndex(s => s.id === supplierId);

            if (supplierIndex !== -1) {
                const name = document.getElementById('supplierName').value.trim();
                const contact = document.getElementById('supplierContact').value.trim();
                const phone = document.getElementById('supplierPhone').value.trim();
                const email = document.getElementById('supplierEmail').value.trim();
                const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
                const category = document.getElementById('supplierCategory').value;
                const address = document.getElementById('supplierAddress').value.trim();
                const notes = document.getElementById('supplierNotes').value.trim();

                if (!name || !phone) {
                    dataManager.showAlert('Please fill in Company Name and Phone.', 'error');
                    return;
                }

                suppliers[supplierIndex] = {
                    ...suppliers[supplierIndex],
                    name,
                    contact,
                    phone,
                    email,
                    taxNumber,
                    category,
                    address,
                    notes,
                    updatedAt: new Date().toISOString()
                };

                if (dataManager.saveData(dataManager.storageKeys.suppliers, suppliers)) {
                    dataManager.showAlert('Supplier updated successfully!', 'success');
                    hideAddSupplierForm();
                    dataManager.updateSuppliersDisplay();
                }
            } else {
                dataManager.showAlert('Supplier not found for update.', 'error');
            }

            function editStaff(staffId) {
                const staff = dataManager.getStaff();
                const staffMember = staff.find(s => s.id === staffId);

                if (!staffMember) {
                    dataManager.showAlert('Staff not found.', 'error');
                    return;
                }

                // عبّي بيانات الموظف في الفورم
                document.getElementById('staffName').value = staffMember.name || '';
                document.getElementById('staffEmail').value = staffMember.email || '';
                document.getElementById('staffPhone').value = staffMember.phone || '';
                document.getElementById('staffRole').value = staffMember.role || '';
                document.getElementById('staffShift').value = staffMember.shift || '';
                document.getElementById('staffSalary').value = staffMember.salary || '';
                document.getElementById('staffHireDate').value = staffMember.hireDate ? staffMember.hireDate.split('T')[0] : '';
                document.getElementById('staffEmployeeId').value = staffMember.employeeId || '';
                document.getElementById('staffNotes').value = staffMember.notes || '';

                // غير الزر من Add Staff → Update Staff
                const saveBtn = document.querySelector("#addStaffForm button.btn-success");
                saveBtn.textContent = "Update Staff";
                saveBtn.setAttribute("onclick", `editStaffSave('${staffId}')`);

                showAddStaffForm(); // يفتح الفورم
            }


        }
        function editStaffSave(staffId) {
            const staff = dataManager.getStaff();
            const staffIndex = staff.findIndex(s => s.id === staffId);

            if (staffIndex !== -1) {
                const name = document.getElementById('staffName').value.trim();
                const email = document.getElementById('staffEmail').value.trim();
                const phone = document.getElementById('staffPhone').value.trim();
                const role = document.getElementById('staffRole').value;
                const shift = document.getElementById('staffShift').value;
                const salary = parseFloat(document.getElementById('staffSalary').value) || 0;
                const hireDate = document.getElementById('staffHireDate').value;
                const employeeId = document.getElementById('staffEmployeeId').value.trim();
                const notes = document.getElementById('staffNotes').value.trim();

                if (!name || !phone) {
                    dataManager.showAlert('Please fill in Staff Name and Phone.', 'error');
                    return;
                }

                staff[staffIndex] = {
                    ...staff[staffIndex],
                    name,
                    email,
                    phone,
                    role,
                    shift,
                    salary,
                    hireDate: hireDate ? new Date(hireDate).toISOString() : null,
                    employeeId,
                    notes,
                    updatedAt: new Date().toISOString()
                };

                if (dataManager.saveData(dataManager.storageKeys.staff, staff)) {
                    dataManager.showAlert('Staff member updated successfully!', 'success');
                    hideAddStaffForm();
                    dataManager.updateStaffDisplay();
                }
            } else {
                dataManager.showAlert('Staff member not found for update.', 'error');
            }
        }


        function clearSupplierForm() {
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierTaxNumber').value = '';
            document.getElementById('supplierCategory').value = '';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierNotes').value = '';
        }

        function deleteSupplier(supplierId) {
            if (confirm('Are you sure you want to delete this supplier?')) {
                const suppliers = dataManager.getSuppliers().filter(s => s.id !== supplierId);
                dataManager.saveData(dataManager.storageKeys.suppliers, suppliers);
                dataManager.showAlert('Supplier deleted successfully', 'success');
                dataManager.updateSuppliersDisplay();
            }
        }

        // Utility Functions
        function refreshOrders() {
            updateOrdersDisplay();
            dataManager.showAlert('Orders refreshed', 'success');
        }

        function refreshKitchen() {
            dataManager.updateKitchenDisplay();
            dataManager.showAlert('Kitchen display refreshed', 'success');
        }

        function updateAllDisplays() {
            if (dataManager) {
                dataManager.updateDashboard();
                updateOrdersDisplay();
                updateMenuDisplay();
                dataManager.updateInventoryDisplay();
                updateCustomersDisplay();
                dataManager.updateLoyaltyDisplay();
                dataManager.updateReservationsDisplay();
                dataManager.updateStaffDisplay();
                dataManager.updateSuppliersDisplay();
                dataManager.updateReportsDisplay();
                dataManager.updateSettingsDisplay();
            }
        }

        function exportDataJSON() {
            if (dataManager) {
                dataManager.exportDataJSON();
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (dataManager.importAllData(JSON.stringify(data))) {
                                dataManager.showAlert('Data imported successfully!', 'success');
                                updateAllDisplays();
                            } else {
                                dataManager.showAlert('Failed to import data', 'error');
                            }
                        } catch (error) {
                            dataManager.showAlert('Invalid file format or corrupted data.', 'error');
                            console.error('Import error:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                if (dataManager) {
                    dataManager.clearAllData();
                    dataManager.showAlert('All data cleared successfully', 'success');
                    updateAllDisplays();
                }
            }
        }

        function changeLanguage() {
            const language = document.getElementById('languageSelect').value;
            dataManager.currentLanguage = language;
            // In a real application, you would load language-specific text here.
            dataManager.showAlert(`Language changed to ${language === 'ar' ? 'Arabic' : 'English'}`, 'success');
        }

        function changeBranch() {
            const branch = document.getElementById('branchSelect').value;
            dataManager.currentBranch = branch;
            dataManager.showAlert(`Switched to ${branch}`, 'success');
            updateAllDisplays(); // Re-render all data for the new branch (if data was branch-specific)
        }

        function exportDataExcel() {
            if (dataManager) {
                dataManager.exportDataExcel();
            }
        }

        function backupData() {
            if (dataManager) {
                dataManager.backupData();
            }
        }

        function generateDailySalesReport() {
            if (dataManager) {
                dataManager.generateDailySalesReport();
            }
        }

        function generateVATReport() {
            if (dataManager) {
                dataManager.generateVATReport();
            }
        }

        function generateProfitReport() {
            if (dataManager) {
                dataManager.generateProfitReport();
            }
        }

        function saveSettings() {
            if (dataManager) {
                dataManager.saveSettings();
            }
        }

        // Additional utility functions can be added here as needed
    </script>
</body>
</html>
